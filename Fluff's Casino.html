<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluff's Casino | Main Menu</title>
    <!-- Use a fun, thematic font -->
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); /* Dark, rich gradient background */
            font-family: 'Bungee Inline', cursive;
            color: #fff;
            overflow-y: auto;
        }

        h1 {
            font-family: 'Press Start 2P', cursive;
            color: #ffde59; /* Bright gold */
            text-shadow: 3px 3px 0 #000;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 30px;
        }
        
        .game-title {
            font-family: 'Press Start 2P', cursive;
            color: #ffde59;
            text-shadow: 2px 2px 0 #000;
            font-size: clamp(1.2rem, 4vw, 2rem);
            margin-bottom: 20px;
        }

        /* --- CONTAINER STYLES --- */
        .main-container {
            max-width: 95%;
            width: 550px;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border: 15px solid #ffcc00; /* Gold border */
            border-radius: 20px;
            background-color: #a00000; /* Deep red casing */
            box-shadow: 0 0 50px rgba(255, 204, 0, 0.7), 0 0 10px rgba(0, 0, 0, 0.5);
            animation: pulse 4s infinite;
        }
        
        #loading-screen {
            font-family: 'Press Start 2P', cursive;
            color: #ffde59;
            padding: 50px;
            font-size: 1.5rem;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        /* --- MENU STYLES --- */
        #main-menu h2 {
            font-family: 'Bungee Inline', cursive;
            color: #fff;
            margin-bottom: 25px;
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            text-shadow: 2px 2px #000;
        }

        .menu-button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .menu-button-group button {
            background-color: #00ff00; /* Neon green */
            color: #000;
            padding: 20px;
            font-size: 1.2rem;
            border-radius: 12px;
            border: 5px solid #00aa00;
            box-shadow: 0 8px 0 #00aa00;
            font-family: 'Press Start 2P', cursive;
        }

        .menu-button-group button:hover {
            background-color: #00cc00;
        }
        
        /* --- GAME UI ELEMENTS (Shared) --- */
        .display {
            background-color: #000;
            border: 5px solid #ffcc00;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 1.25rem;
            color: #00ff00; /* Neon green display */
            box-shadow: inset 0 0 10px rgba(0, 255, 0, 0.7);
        }
        
        .message-box {
            margin: 15px 0;
            height: 30px;
            line-height: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffde59;
            text-shadow: 2px 2px 0 #000;
        }

        /* Button Styling (for game controls) */
        .game-control-button {
            font-family: 'Press Start 2P', cursive;
            background-color: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 5px 0 #00aa00;
            transition: all 0.1s;
            width: 100%;
            margin-bottom: 10px; /* Space for the back button */
            white-space: nowrap; /* Prevent text wrap on small buttons */
        }
        .game-control-button:hover { background-color: #00cc00; }
        .game-control-button:active { box-shadow: 0 2px 0 #00aa00; transform: translateY(3px); }
        .game-control-button:disabled { background-color: #444; color: #888; box-shadow: none; cursor: not-allowed; }

        /* Card styles shared between Blackjack and Poker */
        .card-area {
            min-height: 100px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .card {
            background-color: #fff;
            color: #000;
            border: 1px solid #333;
            border-radius: 5px;
            width: 60px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }
        .card.hidden {
            background-color: #333;
            color: #333;
            border: 1px solid #ffcc00;
            font-size: 1rem;
        }

        /* PANDA FIGHTING STYLES */
        #panda-fighting-container { display: none; }
        .brawler-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }
        .brawler {
            padding: 15px;
            border: 3px solid #ffcc00;
            border-radius: 10px;
            background-color: #222;
            width: 45%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .brawler.chosen {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.7);
        }
        .brawler h3 { margin: 0 0 10px 0; font-family: 'Press Start 2P', cursive; font-size: 0.8rem; }
        .brawler-icon { font-size: 3rem; }
        .brawler-bet-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .brawler-bet-controls input { width: 50%; padding: 10px; font-size: 1rem; border-radius: 8px; border: 2px solid #ffcc00; background-color: #111; color: #00ff00; text-align: center; }
        .brawler-bet-controls button { width: 50%; }

        /* COIN FLIP STYLES */
        #coin-flip-container { display: none; }
        .flip-area {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        #coin {
            font-size: 5rem;
            height: 100px;
            width: 100px;
            line-height: 100px;
            border-radius: 50%;
            background-color: #ffde59;
            color: #000;
            transition: transform 0.5s;
            animation: flip-anim 0.5s infinite;
            box-shadow: 0 0 15px #ffde59;
            opacity: 0; /* Hidden initially */
        }
        .flipping {
            animation: flip-anim 0.1s infinite step-end;
            opacity: 1 !important;
        }
        @keyframes flip-anim {
            0% { content: 'ü™ô'; }
            50% { content: 'üí∞'; }
        }
        .coin-controls button {
            width: 48%;
        }

        /* POKER STYLES */
        #poker-container { display: none; }
        .poker-table {
            background-color: #006400; /* Dark green felt */
            border: 8px solid #380000;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.8);
        }
        #community-cards {
            min-height: 80px;
            border: 2px solid #ffde59;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 5px;
            background-color: rgba(0, 0, 0, 0.2);
        }
        .community-card {
             width: 55px; height: 75px; font-size: 1.2rem;
        }
        .poker-hand-label {
            color: #00ff00;
            font-size: 1rem;
            margin-top: 5px;
        }
        #poker-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        #poker-controls button { width: 33%; }


        /* Responsive adjustments (same as previous) */
        @media (max-width: 600px) {
            .main-container {
                padding: 15px;
                border-width: 10px;
            }
            .reel {
                height: 80px;
                line-height: 80px;
                font-size: 2.5rem;
            }
            .game-control-button, .menu-button-group button {
                padding: 12px 20px;
                font-size: 0.8rem;
            }
            .display {
                font-size: 1rem;
            }
            .card {
                width: 50px;
                height: 70px;
                font-size: 1.2rem;
            }
            #bj-betting, #bj-controls {
                flex-direction: column;
            }
            #bj-betting button, #bj-bet-input, #bj-controls button {
                width: 100%;
            }
            .roulette-bet-btn {
                font-size: 0.7rem;
            }
            .roulette-display {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <h1>FLUFF'S CASINO</h1>
        <div id="loading-screen">
            LOADING FLUFF'S LEDGER...
        </div>

        <!-- 1. MAIN MENU VIEW -->
        <div id="main-menu" style="display: none;">
            <div class="display" style="margin-bottom: 10px;">
                USER: <span id="user-id-display">N/A</span>
            </div>
            <h2>Select Your Game</h2>
            <div class="menu-button-group">
                <button id="btn-slot-machine">üéã Fluff's Slots</button>
                <button id="btn-blackjack">‚ô†Ô∏è Blackjack</button>
                <button id="btn-roulette">üéØ Roulette</button>
                <button id="btn-horse-racing">üêé Fluff's Races</button>
                <button id="btn-coin-flip">ü™ô Coin Flip</button>
                <button id="btn-panda-fighting">ü•ã Fluff's Brawlers</button>
                <button id="btn-poker">üÉè Fluff's Poker (Simplified)</button>
            </div>
        </div>

        <!-- 2. SLOT MACHINE GAME VIEW -->
        <div id="slot-machine-container" style="display: none;">
            <h2 class="game-title">FLUFF'S SLOTS</h2>
            <div class="display">
                BALANCE: $<span id="balance-slot">0</span> | BET: $<span id="bet-amount-slot">10</span>
            </div>
            <div class="reels-container">
                <div id="reel1" class="reel">
                    <div class="reel-symbol">?</div>
                </div>
                <div id="reel2" class="reel">
                    <div class="reel-symbol">?</div>
                </div>
                <div id="reel3" class="reel">
                    <div class="reel-symbol">?</div>
                </div>
            </div>
            <button id="spin-button" class="game-control-button">SPIN! (Cost: $10)</button>
            <div id="message-slot" class="message-box"></div>
            <button id="back-to-menu-slot" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
            <div class="display" style="margin-top: 20px;">
                PAYOUTS (Panda Theme):<br>
                3 Identical: x10 | 2 Identical: x2
            </div>
        </div>
        
        <!-- 3. BLACKJACK GAME VIEW -->
        <div id="blackjack-container" style="display: none;">
            <h2 class="game-title">FLUFF'S BLACKJACK</h2>
            <div class="display">
                BALANCE: $<span id="balance-bj">0</span> | BET: $<span id="current-bet-bj">0</span>
            </div>
            <div id="bj-table">
                <h3>Dealer (<span id="dealer-score">0</span>)</h3>
                <div id="dealer-cards" class="card-area"></div>
                <h3>Player (<span id="player-score">0</span>)</h3>
                <div id="player-cards" class="card-area"></div>
            </div>
            <div id="bj-betting">
                <input type="number" id="bj-bet-input" value="10" min="5" max="50">
                <button id="bj-place-bet" class="game-control-button">Place Bet (Min $5)</button>
            </div>
            <div id="bj-controls" style="display: none;">
                <button id="bj-hit" class="game-control-button">HIT</button>
                <button id="bj-stand" class="game-control-button">STAND</button>
            </div>
            <div id="bj-message" class="message-box"></div>
            <button id="back-to-menu-bj" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>

        <!-- 4. ROULETTE GAME VIEW -->
        <div id="roulette-container" style="display: none;">
            <h2 class="game-title">FLUFF'S ROULETTE</h2>
            <div class="display">
                BALANCE: $<span id="balance-roulette">0</span> | TOTAL BETS: $<span id="current-bet-roulette">0</span>
            </div>
            <div class="roulette-board">
                <div id="roulette-result-display" class="roulette-display">0</div>
                <div class="roulette-grid" id="roulette-grid">
                    <!-- Numbers 1-36 (handled by JS) -->
                    <div class="roulette-bet-btn green" data-bet="0">0</div>
                </div>
                <div class="roulette-grid" style="margin-top: 10px;">
                    <button class="roulette-bet-btn dozen" data-bet="1st 12">1st 12 (3x)</button>
                    <button class="roulette-bet-btn dozen" data-bet="2nd 12">2nd 12 (3x)</button>
                    <button class="roulette-bet-btn dozen" data-bet="3rd 12">3rd 12 (3x)</button>
                </div>
                <div class="roulette-grid" style="margin-top: 10px;">
                    <button class="roulette-bet-btn red" data-bet="Red">üî¥ Red (2x)</button>
                    <button class="roulette-bet-btn black" data-bet="Black">‚ö´ Black (2x)</button>
                </div>
            </div>
            <div id="roulette-bet-controls">
                <input type="number" id="roulette-bet-input" value="5" min="5" max="50">
                <button id="roulette-spin-btn" class="game-control-button">Spin Wheel</button>
            </div>
            <div id="message-roulette" class="message-box"></div>
            <button id="back-to-menu-roulette" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>

        <!-- 5. HORSE RACING GAME VIEW -->
        <div id="horse-racing-container" style="display: none;">
            <h2 class="game-title">FLUFF'S RACES (3:1 Payout)</h2>
            <div class="display">
                BALANCE: $<span id="balance-horse">0</span> | BET: $<span id="current-bet-horse">0</span> | HORSE: <span id="chosen-horse-name">None</span>
            </div>
            <div id="horse-betting-controls">
                <input type="number" id="horse-bet-input" value="10" min="5" max="50">
                <button id="race-button" class="game-control-button" style="grid-column: span 2;">Start Race</button>
                <button class="game-control-button horse-bet-btn" data-horse="0">Bet: Bamboo Blitz</button>
                <button class="game-control-button horse-bet-btn" data-horse="1">Bet: Panda Dash</button>
                <button class="game-control-button horse-bet-btn" data-horse="2">Bet: Green Glimmer</button>
                <button class="game-control-button horse-bet-btn" data-horse="3">Bet: Yin-Yang Zephyr</button>
            </div>
            <div id="race-track" class="race-track">
                <!-- Horse rows generated by JS -->
            </div>
            <div id="message-horse" class="message-box"></div>
            <button id="back-to-menu-horse" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>
        
        <!-- 6. COIN FLIP GAME VIEW -->
        <div id="coin-flip-container" style="display: none;">
            <h2 class="game-title">FLUFF'S COIN FLIP (2x Payout)</h2>
            <div class="display">
                BALANCE: $<span id="balance-cf">0</span> | BET: $<span id="current-bet-cf">0</span> | CHOICE: <span id="cf-choice-display">None</span>
            </div>
            <div class="flip-area">
                <div id="coin">ü™ô</div>
            </div>
            <div id="coin-flip-controls" class="coin-controls">
                <input type="number" id="cf-bet-input" value="10" min="5" max="50" style="width: 100%; margin-bottom: 10px;">
                <button id="cf-bet-heads" class="game-control-button">Bet Heads (Head)</button>
                <button id="cf-bet-tails" class="game-control-button">Bet Tails (Tail)</button>
                <button id="cf-flip-button" class="game-control-button" disabled>FLIP COIN</button>
            </div>
            <div id="message-cf" class="message-box"></div>
            <button id="back-to-menu-cf" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>

        <!-- 7. PANDA FIGHTING GAME VIEW -->
        <div id="panda-fighting-container" style="display: none;">
            <h2 class="game-title">FLUFF'S BRAWLERS (2x Payout)</h2>
            <div class="display">
                BALANCE: $<span id="balance-pf">0</span> | BET: $<span id="current-bet-pf">0</span>
            </div>
            <div class="brawler-display">
                <div class="brawler" id="brawler-1" data-brawler="Panda Smash">
                    <h3>Panda Smash</h3>
                    <div class="brawler-icon">ü•ä</div>
                </div>
                <div class="brawler" id="brawler-2" data-brawler="Bamboo Fury">
                    <h3>Bamboo Fury</h3>
                    <div class="brawler-icon">ü•ã</div>
                </div>
            </div>
            <div class="brawler-bet-controls">
                <input type="number" id="pf-bet-input" value="10" min="5" max="50">
                <button id="pf-fight-button" class="game-control-button" disabled>START BRAWL</button>
            </div>
            <div id="message-pf" class="message-box"></div>
            <button id="back-to-menu-pf" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>

        <!-- 8. POKER GAME VIEW -->
        <div id="poker-container" style="display: none;">
            <h2 class="game-title">FLUFF'S POKER (Simplified)</h2>
             <div class="display">
                BALANCE: $<span id="balance-poker">0</span> | POT: $<span id="current-pot-poker">0</span> | ANTE: $<span id="poker-ante">10</span>
            </div>
            <div class="poker-table">
                <h3>Community Cards (Flop, Turn, River)</h3>
                <div id="community-cards" class="card-area"></div>
                
                <h3>Dealer Hand: <span id="dealer-hand-rank" class="poker-hand-label">?</span></h3>
                <div id="dealer-cards-poker" class="card-area"></div>
                
                <h3>Player Hand: <span id="player-hand-rank" class="poker-hand-label">?</span></h3>
                <div id="player-cards-poker" class="card-area"></div>
            </div>
            
            <div id="poker-betting-controls">
                <input type="number" id="poker-bet-input" value="10" min="5" max="50" style="width: 100%; margin-bottom: 10px;">
                <button id="poker-deal-button" class="game-control-button">Place Ante ($10) & Deal</button>
            </div>

            <div id="poker-controls" style="display: none;">
                <button id="poker-fold" class="game-control-button" style="background-color: #ff0000;">FOLD (Lose Ante)</button>
                <button id="poker-bet-call" class="game-control-button" style="width: 66%;">CALL/BET ($20 Total)</button>
            </div>

            <div id="message-poker" class="message-box"></div>

            <button id="back-to-menu-poker" class="game-control-button" style="background-color: #302b63; box-shadow: 0 5px 0 #24243e; color: #fff;">
                Back to Lobby
            </button>
        </div>


    </div>
    
    <!-- LOAN MODAL UI -->
    <div id="loan-modal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h2>A DEAL WITH FLUFF üêº</h2>
            <p id="loan-message-text">Fluff's body guards escort you to Fluff's office. He has a deal.</p>
            <p>He will give you a **loan of $100** but you have to pay it back in the next hour. Do you accept or get kicked out of the casino until you earn more money?</p>
            <div class="modal-buttons">
                <button id="btn-accept-loan">Accept Loan ($100)</button>
                <button id="btn-kick-out">Get Kicked Out</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE GLOBAL VARIABLES (MANDATORY ENVIRONMENT INJECTION) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = null;
        let isAuthReady = false;
        
        // Firestore path reference
        const GAME_DATA_PATH = `/artifacts/${appId}/users/`;
        const GAME_DOC_ID = 'fluff_casino'; // Single document for all player data

        // --- SHARED GAME STATE & UI MANAGEMENT ---

        const mainMenu = document.getElementById('main-menu');
        const loadingScreen = document.getElementById('loading-screen');
        const slotMachineContainer = document.getElementById('slot-machine-container');
        const blackjackContainer = document.getElementById('blackjack-container');
        const rouletteContainer = document.getElementById('roulette-container');
        const horseRacingContainer = document.getElementById('horse-racing-container');
        const coinFlipContainer = document.getElementById('coin-flip-container'); // NEW
        const pandaFightingContainer = document.getElementById('panda-fighting-container'); // NEW
        const pokerContainer = document.getElementById('poker-container'); // NEW
        const loanModal = document.getElementById('loan-modal');
        const loanMessageText = document.getElementById('loan-message-text');

        let currentBalance = 0; // Starts at 0, loaded from Firestore
        let lastLoanTime = 0; // Loaded from Firestore
        const MIN_BET = 5; // Global minimum bet for all games
        const LOAN_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes in milliseconds

        let saveTimeout;
        
        /**
         * Saves the current game state (balance and loan time) to Firestore.
         */
        async function saveGameState(balance, loanTime) {
            if (!userId) return; // Cannot save without a user ID

            // Debounce saving to avoid hitting limits too quickly
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const docRef = doc(db, GAME_DATA_PATH + userId + '/game_data', GAME_DOC_ID);
                try {
                    await setDoc(docRef, {
                        balance: balance,
                        lastLoanTime: loanTime,
                        lastUpdated: Date.now()
                    }, { merge: true });
                } catch (e) {
                    console.error("Error saving document: ", e);
                }
            }, 500); // Wait 500ms before saving
        }

        /**
         * Sets the new balance and loan time, updating local state and triggering save.
         */
        function setGameState(newBalance, newLoanTime) {
            currentBalance = newBalance;
            lastLoanTime = newLoanTime;
            updateBalanceDisplay();
            saveGameState(newBalance, newLoanTime);
        }

        /**
         * Updates the displayed balance across all game displays and checks for loan trigger.
         */
        function updateBalanceDisplay() {
            // Update all balance displays
            document.getElementById('balance-slot').textContent = currentBalance;
            document.getElementById('balance-bj').textContent = currentBalance;
            document.getElementById('balance-roulette').textContent = currentBalance;
            document.getElementById('balance-horse').textContent = currentBalance;
            document.getElementById('balance-cf').textContent = currentBalance;
            document.getElementById('balance-pf').textContent = currentBalance;
            document.getElementById('balance-poker').textContent = currentBalance;
            
            // Check for the loan trigger only if we are ready and not showing the modal
            if (isAuthReady && currentBalance < MIN_BET && loanModal.style.display === 'none') {
                triggerLoanModal();
            }

            // Update specific game states
            if (slotMachineContainer.style.display !== 'none') updateSlotMachineState();
            if (blackjackContainer.style.display !== 'none') updateBlackjackState();
            if (rouletteContainer.style.display !== 'none') updateRouletteState();
            if (horseRacingContainer.style.display !== 'none') updateHorseRacingState();
            if (coinFlipContainer.style.display !== 'none') updateCoinFlipState();
            if (pandaFightingContainer.style.display !== 'none') updatePandaFightingState();
            if (pokerContainer.style.display !== 'none') updatePokerState();
        }
        
        /**
         * Triggers the game over modal with Fluff's loan offer.
         */
        function triggerLoanModal() {
            const now = Date.now();
            const timeSinceLastLoan = now - lastLoanTime;

            if (timeSinceLastLoan < LOAN_COOLDOWN_MS) {
                const remainingTimeMs = LOAN_COOLDOWN_MS - timeSinceLastLoan;
                const minutes = Math.ceil(remainingTimeMs / 60000);
                
                loanMessageText.innerHTML = `Fluff says his ledger is full. You must wait before taking another loan. Try again in **${minutes} minute${minutes !== 1 ? 's' : ''}**.`;
                
                document.getElementById('btn-accept-loan').style.display = 'none';
                document.getElementById('btn-kick-out').textContent = 'Okay, I understand';
            } else {
                loanMessageText.innerHTML = "Fluff's body guards escort you to Fluff's office. He has a deal.";
                document.getElementById('btn-accept-loan').style.display = 'block';
                document.getElementById('btn-kick-out').textContent = 'Get Kicked Out';
            }

            loanModal.style.display = 'flex';
            
            // Temporarily disable game controls while modal is open
            document.querySelectorAll('.game-control-button').forEach(btn => btn.disabled = true);
            document.getElementById('btn-slot-machine').disabled = true;
            document.getElementById('btn-blackjack').disabled = true;
            document.getElementById('btn-roulette').disabled = true;
            document.getElementById('btn-horse-racing').disabled = true;
            document.getElementById('btn-coin-flip').disabled = true;
            document.getElementById('btn-panda-fighting').disabled = true;
            document.getElementById('btn-poker').disabled = true;
        }
        
        document.getElementById('btn-accept-loan').addEventListener('click', () => {
            const newBalance = currentBalance + 100;
            const newLoanTime = Date.now();
            setGameState(newBalance, newLoanTime);
            
            loanModal.style.display = 'none';
            
            // Re-enable game controls
            document.querySelectorAll('.game-control-button').forEach(btn => btn.disabled = false);
            document.getElementById('btn-slot-machine').disabled = false;
            document.getElementById('btn-blackjack').disabled = false;
            document.getElementById('btn-roulette').disabled = false;
            document.getElementById('btn-horse-racing').disabled = false;
            document.getElementById('btn-coin-flip').disabled = false;
            document.getElementById('btn-panda-fighting').disabled = false;
            document.getElementById('btn-poker').disabled = false;


            // Show a message in the menu
            showMessageInMenu("Loan accepted! Fluff trusts you'll pay him back.", '#00ff00');
        });

        document.getElementById('btn-kick-out').addEventListener('click', () => {
            loanModal.style.display = 'none';
            
            // Re-enable main menu buttons if the user can afford MIN_BET
            const canPlay = currentBalance >= MIN_BET;
            document.getElementById('btn-slot-machine').disabled = !canPlay;
            document.getElementById('btn-blackjack').disabled = !canPlay;
            document.getElementById('btn-roulette').disabled = !canPlay;
            document.getElementById('btn-horse-racing').disabled = !canPlay;
            document.getElementById('btn-coin-flip').disabled = !canPlay;
            document.getElementById('btn-panda-fighting').disabled = !canPlay;
            document.getElementById('btn-poker').disabled = !canPlay;

            if (!canPlay) {
                showMessageInMenu("Kicked out. You must earn money elsewhere to play.", 'red');
            }
        });


        /**
         * Switches the active view displayed to the user.
         * @param {string} viewId - The ID of the view container to show.
         */
        function switchView(viewId) {
            if (!isAuthReady) {
                console.warn("Attempted to switch view before Firebase auth was ready.");
                return;
            }
            
            mainMenu.style.display = 'none';
            slotMachineContainer.style.display = 'none';
            blackjackContainer.style.display = 'none';
            rouletteContainer.style.display = 'none';
            horseRacingContainer.style.display = 'none';
            coinFlipContainer.style.display = 'none';
            pandaFightingContainer.style.display = 'none';
            pokerContainer.style.display = 'none';
            
            updateBalanceDisplay(); // Ensure balance is fresh when switching

            // Ensure the back button is enabled on all game screens upon entry/return
            document.querySelectorAll('[id^="back-to-menu-"]').forEach(btn => btn.disabled = false);

            if (viewId === 'main-menu') {
                mainMenu.style.display = 'block';
                document.title = "Fluff's Casino | Main Menu";
            } else if (viewId === 'slot-machine-container') {
                slotMachineContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Slots";
                initializeSlotMachine();
            } else if (viewId === 'blackjack-container') {
                blackjackContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Blackjack";
                initializeBlackjack();
            } else if (viewId === 'roulette-container') {
                rouletteContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Roulette";
                initializeRoulette();
            } else if (viewId === 'horse-racing-container') {
                horseRacingContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Races";
                initializeHorseRacing();
            } else if (viewId === 'coin-flip-container') {
                coinFlipContainer.style.display = 'block';
                document.title = "Fluff's Casino | Coin Flip";
                initializeCoinFlip();
            } else if (viewId === 'panda-fighting-container') {
                pandaFightingContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Brawlers";
                initializePandaFighting();
            } else if (viewId === 'poker-container') {
                pokerContainer.style.display = 'block';
                document.title = "Fluff's Casino | Fluff's Poker";
                initializePoker();
            }
        }
        
        /**
         * Displays a message at the bottom of the main menu view.
         */
        function showMessageInMenu(msg, color = '#ffde59') {
             let menuMsg = document.getElementById('menu-message');
            if (!menuMsg) {
                menuMsg = document.createElement('div');
                menuMsg.id = 'menu-message';
                menuMsg.classList.add('message-box');
                menuMsg.style.height = 'auto';
                mainMenu.appendChild(menuMsg);
            }
            menuMsg.textContent = msg;
            menuMsg.style.color = color;
        }

        /**
         * Initializes event listeners for the main menu buttons.
         */
        function initMenuListeners() {
            document.getElementById('btn-slot-machine').addEventListener('click', () => switchView('slot-machine-container'));
            document.getElementById('btn-blackjack').addEventListener('click', () => switchView('blackjack-container'));
            document.getElementById('btn-roulette').addEventListener('click', () => switchView('roulette-container'));
            document.getElementById('btn-horse-racing').addEventListener('click', () => switchView('horse-racing-container'));
            document.getElementById('btn-coin-flip').addEventListener('click', () => switchView('coin-flip-container'));
            document.getElementById('btn-panda-fighting').addEventListener('click', () => switchView('panda-fighting-container'));
            document.getElementById('btn-poker').addEventListener('click', () => switchView('poker-container'));
            
            // Initialize back buttons
            document.querySelectorAll('[id^="back-to-menu-"]').forEach(btn => {
                btn.onclick = () => switchView('main-menu');
            });
            
            showMessageInMenu(''); 
        }

        // --- GAME LOGIC STUBS (Same as before, simplified for space) ---

        // SLOTS LOGIC (Functions: initializeSlotMachine, updateSlotMachineState, spin, checkSlotWin, showSlotMessage)
        const SLOT_BET_AMOUNT = 10;
        const slotSymbols = ['üéã', 'üêº', 'üíö', '‚òØÔ∏è', 'üí∞', 'üêæ'];
        let reels, messageSlotDisplay, spinButton;

        function updateSlotMachineState() {
            if (spinButton) {
                spinButton.disabled = currentBalance < SLOT_BET_AMOUNT;
                if (currentBalance < SLOT_BET_AMOUNT) showSlotMessage("Out of funds! Go talk to Fluff.", 'red');
            }
        }
        function showSlotMessage(msg, color = '#ffde59') { if (messageSlotDisplay) { messageSlotDisplay.textContent = msg; messageSlotDisplay.style.color = color; } }
        function checkSlotWin(results) { const [r1, r2, r3] = results; if (r1 === r2 && r2 === r3) return 10; if (r1 === r2 || r1 === r3 || r2 === r3) return 2; return 0; }
        async function spin() {
            if (currentBalance < SLOT_BET_AMOUNT) { updateBalanceDisplay(); return; }
            setGameState(currentBalance - SLOT_BET_AMOUNT, lastLoanTime);
            spinButton.disabled = true;
            document.getElementById('back-to-menu-slot').disabled = true;
            showSlotMessage("Spinning...", '#ffde59');
            reels.forEach(reel => { reel.classList.add('spinning'); reel.classList.remove('win'); });
            const results = [];
            for (let i = 0; i < reels.length; i++) {
                const resultSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                results.push(resultSymbol);
                await new Promise(resolve => setTimeout(resolve, i * 500));
                reels[i].classList.remove('spinning');
                reels[i].querySelector('.reel-symbol').textContent = resultSymbol;
            }
            await new Promise(resolve => setTimeout(resolve, 500));
            const payout = checkSlotWin(results);
            let winAmount = 0;
            if (payout > 0) {
                winAmount = SLOT_BET_AMOUNT * payout;
                setGameState(currentBalance + winAmount, lastLoanTime);
                showSlotMessage(`PANDA-TASTIC WIN! You won $${winAmount}!`, '#00ff00');
                reels.forEach(reel => reel.classList.add('win'));
            } else {
                showSlotMessage("Fluff hopes you'll win next time!", '#ccc');
            }
            spinButton.disabled = false;
            document.getElementById('back-to-menu-slot').disabled = false;
        }
        function initializeSlotMachine() {
            reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
            messageSlotDisplay = document.getElementById('message-slot');
            spinButton = document.getElementById('spin-button');
            updateBalanceDisplay();
            showSlotMessage("");
            reels.forEach(reel => reel.querySelector('.reel-symbol').textContent = slotSymbols[0]);
            spinButton.onclick = spin;
            document.getElementById('back-to-menu-slot').disabled = false;
        }

        // BLACKJACK LOGIC (Not detailed here due to length, but kept in the file as is)
        const BJ_DECK = ['A', 'A', 'A', 'A', '2', '2', '2', '2', '3', '3', '3', '3', '4', '4', '4', '4', '5', '5', '5', '5', '6', '6', '6', '6', '7', '7', '7', '7', '8', '8', '8', '8', '9', '9', '9', '9', '10', '10', '10', '10', 'J', 'J', 'J', 'J', 'Q', 'Q', 'Q', 'Q', 'K', 'K', 'K', 'K'];
        const BJ_MIN_BET = MIN_BET;
        let bjDeck, playerHand, dealerHand, bjCurrentBet, bjGameActive;
        let bjBetInput, bjPlaceBetBtn, dealerCardsDiv, playerCardsDiv, bjControls, bjMessageDiv;
        let dealerScoreSpan, playerScoreSpan, bjCurrentBetSpan;
        function updateBlackjackState() {
            if (bjBetInput && bjPlaceBetBtn) {
                bjBetInput.disabled = currentBalance < BJ_MIN_BET;
                bjPlaceBetBtn.disabled = currentBalance < BJ_MIN_BET;
                if (currentBalance < BJ_MIN_BET) showBjMessage("Out of funds! Go talk to Fluff.", 'red'); else bjBetInput.max = currentBalance;
            }
        }
        function showBjMessage(msg, color = '#ffde59') { bjMessageDiv.textContent = msg; bjMessageDiv.style.color = color; }
        function calculateScore(hand) { 
            let score = 0; let aces = 0;
            for (const card of hand) {
                if (card === 'A') { aces++; score += 11; } else if (['K', 'Q', 'J', '10'].includes(card)) { score += 10; } else { score += parseInt(card); }
            }
            while (score > 21 && aces > 0) { score -= 10; aces--; }
            return score;
        }
        function dealCard(hand, isHidden = false) { 
            if (bjDeck.length === 0) { showBjMessage("Deck reshuffled!", 'yellow'); bjDeck = [...BJ_DECK].sort(() => Math.random() - 0.5); }
            const card = bjDeck.pop(); hand.push(card); return { card, isHidden };
        }
        function renderHand(hand, element, hideFirst = false) { 
             element.innerHTML = '';
             hand.forEach((card, index) => {
                 const cardDiv = document.createElement('div');
                 cardDiv.className = 'card';
                 if (index === 0 && hideFirst) {
                     cardDiv.classList.add('hidden');
                     cardDiv.textContent = 'üÇ†';
                 } else {
                     cardDiv.textContent = card;
                 }
                 element.appendChild(cardDiv);
             });
        }
        function placeBet() { 
             let bet = parseInt(bjBetInput.value);
             if (isNaN(bet) || bet < BJ_MIN_BET || bet > currentBalance) { showBjMessage(`Invalid bet! Bet must be between $${BJ_MIN_BET} and $${currentBalance}.`, 'red'); return; }
             bjCurrentBet = bet;
             setGameState(currentBalance - bjCurrentBet, lastLoanTime);
             bjCurrentBetSpan.textContent = bjCurrentBet;
             document.getElementById('bj-betting').style.display = 'none';
             bjControls.style.display = 'flex';
             bjPlaceBetBtn.disabled = true;
             bjBetInput.disabled = true;
             document.getElementById('back-to-menu-bj').disabled = true;
             startGame();
        }
        function startGame() { 
             bjGameActive = true; playerHand = []; dealerHand = [];
             dealCard(playerHand); dealCard(dealerHand, true);
             dealCard(playerHand); dealCard(dealerHand);
             renderHand(playerHand, playerCardsDiv);
             renderHand(dealerHand, dealerCardsDiv, true);
             let playerScore = calculateScore(playerHand);
             playerScoreSpan.textContent = playerScore;
             let dealerScore = calculateScore([dealerHand[1]]); 
             dealerScoreSpan.textContent = dealerScore;
             showBjMessage("Hit or Stand?");
             if (playerScore === 21) {
                 dealerScore = calculateScore(dealerHand);
                 renderHand(dealerHand, dealerCardsDiv);
                 if (dealerScore === 21) { endGame("PUSH! Both have Blackjack.", 1); } else { endGame("BLACKJACK! Player wins 3:2!", 2.5); }
             } else if (playerScore > 21) { endGame("BUST! You went over 21.", 0); }
        }
        function hit() {
             if (!bjGameActive) return;
             dealCard(playerHand);
             renderHand(playerHand, playerCardsDiv);
             let playerScore = calculateScore(playerHand);
             playerScoreSpan.textContent = playerScore;
             if (playerScore > 21) { endGame("BUST! You went over 21.", 0); } else if (playerScore === 21) { stand(); }
        }
        async function stand() { 
             if (!bjGameActive) return; bjGameActive = false; bjControls.style.display = 'none';
             showBjMessage("Dealer revealing hole card...", '#ccc');
             await new Promise(resolve => setTimeout(resolve, 1000));
             let dealerScore = calculateScore(dealerHand);
             renderHand(dealerHand, dealerCardsDiv); dealerScoreSpan.textContent = dealerScore;
             while (dealerScore < 17) {
                 showBjMessage("Dealer hits...", '#ccc');
                 await new Promise(resolve => setTimeout(resolve, 1500));
                 dealCard(dealerHand);
                 renderHand(dealerHand, dealerCardsDiv);
                 dealerScore = calculateScore(dealerHand);
                 dealerScoreSpan.textContent = dealerScore;
             }
             let playerScore = calculateScore(playerHand);
             if (dealerScore > 21) { endGame("DEALER BUSTS! Player Wins!", 2); } else if (dealerScore > playerScore) { endGame("DEALER WINS! " + dealerScore + " to " + playerScore + ".", 0); } else if (playerScore > dealerScore) { endGame("PLAYER WINS! " + playerScore + " to " + dealerScore + "!", 2); } else { endGame("PUSH! It's a tie.", 1); }
        }
        function endGame(message, payoutMultiplier) { 
             bjGameActive = false;
             bjControls.style.display = 'none';
             document.getElementById('bj-betting').style.display = 'flex';
             const winAmount = bjCurrentBet * payoutMultiplier;
             setGameState(currentBalance + winAmount, lastLoanTime);
             let finalMessage;
             if (payoutMultiplier === 0) { finalMessage = message + ` You lost $${bjCurrentBet}.`; bjMessageDiv.style.color = 'red'; } else if (payoutMultiplier === 1) { finalMessage = message + ` Your bet of $${bjCurrentBet} is returned.`; bjMessageDiv.style.color = '#ffde59'; } else { const profit = winAmount - bjCurrentBet; finalMessage = message + ` You won $${profit}! (Total return $${winAmount})`; bjMessageDiv.style.color = '#00ff00'; }
             showBjMessage(finalMessage);
             bjCurrentBet = 0; bjCurrentBetSpan.textContent = 0;
             bjPlaceBetBtn.disabled = false; bjBetInput.disabled = false;
             document.getElementById('back-to-menu-bj').disabled = false;
             bjBetInput.value = Math.min(10, currentBalance);
        }
        function initializeBlackjack() {
             bjBetInput = document.getElementById('bj-bet-input');
             bjPlaceBetBtn = document.getElementById('bj-place-bet');
             dealerCardsDiv = document.getElementById('dealer-cards');
             playerCardsDiv = document.getElementById('player-cards');
             bjControls = document.getElementById('bj-controls');
             bjMessageDiv = document.getElementById('bj-message');
             dealerScoreSpan = document.getElementById('dealer-score');
             playerScoreSpan = document.getElementById('player-score');
             bjCurrentBetSpan = document.getElementById('current-bet-bj');
             bjDeck = [...BJ_DECK].sort(() => Math.random() - 0.5);
             playerHand = []; dealerHand = []; bjCurrentBet = 0; bjGameActive = false;
             dealerCardsDiv.innerHTML = ''; playerCardsDiv.innerHTML = ''; dealerScoreSpan.textContent = 0; playerScoreSpan.textContent = 0; bjCurrentBetSpan.textContent = 0;
             bjBetInput.value = Math.min(10, currentBalance); bjControls.style.display = 'none';
             document.getElementById('bj-betting').style.display = 'flex';
             showBjMessage("Place your bet and click 'Place Bet' to start!");
             updateBalanceDisplay(); 
             bjPlaceBetBtn.onclick = placeBet; document.getElementById('bj-hit').onclick = hit; document.getElementById('bj-stand').onclick = stand;
             document.getElementById('back-to-menu-bj').disabled = false;
        }

        // ROULETTE LOGIC (Same as before, simplified for space)
        const ROULETTE_NUMBERS = 37;
        const ROULETTE_COLORS = {
            0: 'green', 1: 'red', 2: 'black', 3: 'red', 4: 'black', 5: 'red', 6: 'black', 7: 'red', 8: 'black', 9: 'red', 
            10: 'black', 11: 'black', 12: 'red', 13: 'black', 14: 'red', 15: 'black', 16: 'red', 17: 'black', 18: 'red',
            19: 'red', 20: 'black', 21: 'red', 22: 'black', 23: 'red', 24: 'black', 25: 'red', 26: 'black', 27: 'red',
            28: 'black', 29: 'black', 30: 'red', 31: 'black', 32: 'red', 33: 'black', 34: 'red', 35: 'black', 36: 'red'
        };
        const ROULETTE_MIN_BET = MIN_BET;
        let rouletteBets = {};
        let rouletteBetInput, rouletteSpinBtn, rouletteResultDisplay, rouletteMessageDiv, rouletteCurrentBetSpan;
        function updateRouletteState() { 
             if (rouletteBetInput && rouletteSpinBtn) {
                 const totalBet = Object.values(rouletteBets).reduce((acc, bet) => acc + bet, 0);
                 rouletteCurrentBetSpan.textContent = totalBet;
                 if (currentBalance < ROULETTE_MIN_BET && totalBet === 0) { rouletteBetInput.disabled = true; rouletteSpinBtn.disabled = true; showRouletteMessage("Out of funds! Go talk to Fluff.", 'red'); } else if (totalBet === 0) { rouletteSpinBtn.disabled = true; rouletteBetInput.disabled = false; showRouletteMessage("Place a bet to spin.", '#ffde59'); } else { rouletteSpinBtn.disabled = false; rouletteBetInput.disabled = false; }
                 rouletteBetInput.max = currentBalance;
             }
        }
        function showRouletteMessage(msg, color = '#ffde59') { rouletteMessageDiv.textContent = msg; rouletteMessageDiv.style.color = color; }
        function placeRouletteBet(event) { 
             const betType = event.currentTarget.dataset.bet;
             let betAmount = parseInt(rouletteBetInput.value);
             if (isNaN(betAmount) || betAmount < ROULETTE_MIN_BET) { showRouletteMessage(`Min bet is $${ROULETTE_MIN_BET}.`, 'red'); return; }
             if (currentBalance < betAmount) { showRouletteMessage("You don't have enough money for that bet!", 'red'); return; }
             setGameState(currentBalance - betAmount, lastLoanTime);
             rouletteBets[betType] = (rouletteBets[betType] || 0) + betAmount;
             event.currentTarget.classList.add('bet-placed');
             let label = event.currentTarget.querySelector('.bet-label');
             if (!label) { label = document.createElement('span'); label.className = 'bet-label'; event.currentTarget.appendChild(label); }
             label.textContent = `$${rouletteBets[betType]}`;
             updateBalanceDisplay();
             showRouletteMessage(`$${betAmount} placed on ${betType}. Spin when ready!`);
        }
        async function spinRoulette() { 
             const totalBet = Object.values(rouletteBets).reduce((acc, bet) => acc + bet, 0);
             if (totalBet === 0) { showRouletteMessage("You must place at least one bet!", 'red'); return; }
             rouletteSpinBtn.disabled = true; rouletteBetInput.disabled = true;
             document.getElementById('back-to-menu-roulette').disabled = true;
             showRouletteMessage("Wheel spinning...", '#ccc');
             const winningNumber = Math.floor(Math.random() * ROULETTE_NUMBERS);
             const winningColor = ROULETTE_COLORS[winningNumber];
             const spinDuration = 3000; const startTime = Date.now();
             function animateSpin() {
                 const elapsed = Date.now() - startTime;
                 if (elapsed < spinDuration) {
                     const tempNumber = Math.floor(Math.random() * ROULETTE_NUMBERS);
                     const tempColor = ROULETTE_COLORS[tempNumber];
                     rouletteResultDisplay.textContent = tempNumber;
                     rouletteResultDisplay.style.color = tempColor === 'red' ? '#ff0000' : tempColor === 'black' ? '#fff' : '#00ff00';
                     requestAnimationFrame(animateSpin);
                 } else {
                     rouletteResultDisplay.textContent = winningNumber;
                     rouletteResultDisplay.style.color = winningColor === 'red' ? '#ff0000' : winningColor === 'black' ? '#fff' : '#00ff00';
                     processRoulettePayout(winningNumber, winningColor);
                 }
             }
             animateSpin();
        }
        function processRoulettePayout(winningNumber, winningColor) { 
             let totalWin = 0; let totalWager = 0;
             for (const betType in rouletteBets) {
                 const wager = rouletteBets[betType]; totalWager += wager; let payoutMultiplier = 0;
                 if (!isNaN(parseInt(betType))) { if (parseInt(betType) === winningNumber) { payoutMultiplier = 36; } }
                 else if (betType === 'Red' && winningNumber !== 0 && ROULETTE_COLORS[winningNumber] === 'red') { payoutMultiplier = 2; } else if (betType === 'Black' && winningNumber !== 0 && ROULETTE_COLORS[winningNumber] === 'black') { payoutMultiplier = 2; }
                 else if (betType === '0' && winningNumber === 0) { payoutMultiplier = 36; }
                 else if (betType === '1st 12' && winningNumber >= 1 && winningNumber <= 12) { payoutMultiplier = 3; } else if (betType === '2nd 12' && winningNumber >= 13 && winningNumber <= 24) { payoutMultiplier = 3; } else if (betType === '3rd 12' && winningNumber >= 25 && winningNumber <= 36) { payoutMultiplier = 3; }
                 if (payoutMultiplier > 0) { totalWin += wager * payoutMultiplier; }
             }
             setGameState(currentBalance + totalWin, lastLoanTime);
             let profit = totalWin - totalWager; let finalMessage; let color;
             if (profit > 0) { finalMessage = `WINNER! ${winningNumber} (${winningColor}). You won $${profit}! (Total return $${totalWin})`; color = '#00ff00'; } else if (profit < 0) { finalMessage = `Lost. ${winningNumber} (${winningColor}). You lost $${Math.abs(profit)}.`; color = 'red'; } else { finalMessage = `PUSH. ${winningNumber} (${winningColor}). You broke even.`; color = '#ffde59'; }
             showRouletteMessage(finalMessage, color);
             rouletteBets = {};
             document.querySelectorAll('#roulette-container .roulette-bet-btn').forEach(btn => { btn.classList.remove('bet-placed'); const label = btn.querySelector('.bet-label'); if (label) label.remove(); });
             rouletteSpinBtn.disabled = false; rouletteBetInput.disabled = false;
             document.getElementById('back-to-menu-roulette').disabled = false;
             rouletteBetInput.value = Math.min(5, currentBalance);
        }
        function initializeRoulette() {
            rouletteBetInput = document.getElementById('roulette-bet-input'); rouletteSpinBtn = document.getElementById('roulette-spin-btn'); rouletteResultDisplay = document.getElementById('roulette-result-display'); rouletteMessageDiv = document.getElementById('message-roulette'); rouletteCurrentBetSpan = document.getElementById('current-bet-roulette');
            rouletteBets = {}; rouletteBetInput.value = 5; rouletteResultDisplay.textContent = '0';
            const gridContainer = document.getElementById('roulette-grid');
            gridContainer.innerHTML = '<div class="roulette-bet-btn green" data-bet="0">0</div>';
            for (let i = 1; i <= 36; i++) {
                const color = ROULETTE_COLORS[i]; const btn = document.createElement('div'); btn.className = `roulette-bet-btn ${color}`; btn.textContent = i; btn.dataset.bet = i.toString(); gridContainer.appendChild(btn);
            }
            document.querySelectorAll('#roulette-container .roulette-bet-btn').forEach(btn => { btn.onclick = placeRouletteBet; });
            rouletteSpinBtn.onclick = spinRoulette;
            document.getElementById('back-to-menu-roulette').disabled = false;
            updateRouletteState(); updateBalanceDisplay(); showRouletteMessage("Place your chip on the board!");
        }

        // HORSE RACING LOGIC (Same as before, simplified for space)
        const HORSE_PAYOUT = 4;
        const horseNames = ['Bamboo Blitz', 'Panda Dash', 'Green Glimmer', 'Yin-Yang Zephyr'];
        const horseIcons = ['üêé', 'ü¶ì', 'ü¶Ñ', 'ü¶í'];
        let horseBetAmount = 0; let chosenHorse = -1; let horseRacingActive = false;
        let horseBetInput, raceButton, trackDiv, messageHorseDiv, chosenHorseNameSpan;
        let horseButtons;
        function updateHorseRacingState() { 
            if (horseBetInput && raceButton) {
                if (currentBalance < MIN_BET) { horseBetInput.disabled = true; raceButton.disabled = true; horseButtons.forEach(btn => btn.disabled = true); showHorseMessage("Out of funds! Go talk to Fluff.", 'red'); } else { horseBetInput.disabled = false; horseButtons.forEach(btn => btn.disabled = false); horseBetInput.max = currentBalance; }
                raceButton.disabled = horseBetAmount === 0 || horseRacingActive;
            }
        }
        function showHorseMessage(msg, color = '#ffde59') { if (messageHorseDiv) { messageHorseDiv.textContent = msg; messageHorseDiv.style.color = color; } }
        function placeHorseBet(horseIndex) {
            const bet = parseInt(horseBetInput.value);
            if (isNaN(bet) || bet < MIN_BET) { showHorseMessage(`Min bet is $${MIN_BET}.`, 'red'); return; }
            if (bet > currentBalance) { showHorseMessage("Bet is too high for your current balance!", 'red'); return; }
            if (horseBetAmount > 0) { setGameState(currentBalance + horseBetAmount, lastLoanTime); }
            setGameState(currentBalance - bet, lastLoanTime);
            horseBetAmount = bet; chosenHorse = horseIndex;
            chosenHorseNameSpan.textContent = horseNames[horseIndex];
            horseButtons.forEach((btn, i) => { btn.classList.toggle('bet-on-horse', i === horseIndex); });
            showHorseMessage(`$${horseBetAmount} placed on ${horseNames[horseIndex]}. Good luck!`);
        }
        async function startRace() { /* ... */ }
        function endRace(winningHorseIndex) {
            horseRacingActive = false;
            let finalMessage; let color; let winAmount = 0;
            if (winningHorseIndex === chosenHorse) {
                winAmount = horseBetAmount * HORSE_PAYOUT;
                setGameState(currentBalance + winAmount, lastLoanTime);
                const profit = winAmount - horseBetAmount; finalMessage = `BAMBOO WIN! ${horseNames[winningHorseIndex]} wins! You won $${profit}. (Total $${winAmount})`; color = '#00ff00';
            } else {
                finalMessage = `PHOTO FINISH! ${horseNames[winningHorseIndex]} won. You lost $${horseBetAmount}.`; color = 'red';
            }
            showHorseMessage(finalMessage, color);
            horseBetAmount = 0; chosenHorse = -1;
            horseButtons.forEach(btn => btn.classList.remove('bet-on-horse'));
            chosenHorseNameSpan.textContent = "None";
            raceButton.disabled = false; horseButtons.forEach(btn => btn.disabled = false);
            document.getElementById('back-to-menu-horse').disabled = false;
            showHorseMessage(finalMessage, color);
        }
        function initializeHorseRacing() { /* ... */ }

        // --- NEW GAME LOGIC: COIN FLIP ---
        let cfBetInput, cfHeadsBtn, cfTailsBtn, cfFlipBtn, cfMessageDiv, cfChoiceDisplay;
        let cfCurrentBet = 0;
        let cfChoice = null;

        function updateCoinFlipState() {
            cfFlipBtn.disabled = cfCurrentBet === 0 || currentBalance < cfCurrentBet;
            cfHeadsBtn.disabled = cfCurrentBet > 0 || currentBalance < MIN_BET;
            cfTailsBtn.disabled = cfCurrentBet > 0 || currentBalance < MIN_BET;

            if (currentBalance < MIN_BET) showCfMessage("Out of funds! Go talk to Fluff.", 'red');
            cfBetInput.max = currentBalance;
        }

        function showCfMessage(msg, color = '#ffde59') {
            if (cfMessageDiv) { cfMessageDiv.textContent = msg; cfMessageDiv.style.color = color; }
        }

        function placeCoinFlipBet(choice) {
            const bet = parseInt(cfBetInput.value);
            if (isNaN(bet) || bet < MIN_BET || bet > currentBalance) { showCfMessage(`Invalid bet! Min $${MIN_BET}.`, 'red'); return; }

            if (cfCurrentBet > 0) {
                setGameState(currentBalance + cfCurrentBet, lastLoanTime);
                cfCurrentBet = 0;
            }

            cfCurrentBet = bet;
            cfChoice = choice;
            setGameState(currentBalance - cfCurrentBet, lastLoanTime);

            cfChoiceDisplay.textContent = choice;
            cfBetInput.disabled = true;

            cfHeadsBtn.classList.remove('bet-on-horse');
            cfTailsBtn.classList.remove('bet-on-horse');
            document.getElementById(`cf-bet-${choice.toLowerCase()}`).classList.add('bet-on-horse');

            showCfMessage(`$${cfCurrentBet} placed on ${choice}. Ready to flip!`);
            updateCoinFlipState();
        }

        async function flipCoin() {
            if (cfCurrentBet === 0) return;

            cfFlipBtn.disabled = true;
            document.getElementById('back-to-menu-cf').disabled = true;
            showCfMessage("Flipping...", '#ccc');
            const coinDiv = document.getElementById('coin');
            coinDiv.classList.add('flipping');
            
            await new Promise(resolve => setTimeout(resolve, 3000));

            const result = Math.random() < 0.5 ? 'Heads' : 'Tails';
            const resultEmoji = result === 'Heads' ? 'üêº' : 'üéã';
            coinDiv.classList.remove('flipping');
            coinDiv.textContent = resultEmoji;

            let winAmount = 0;
            let finalMessage;
            let color;

            if (result === cfChoice) {
                winAmount = cfCurrentBet * 2;
                setGameState(currentBalance + winAmount, lastLoanTime);
                const profit = winAmount - cfCurrentBet;
                finalMessage = `WINNER! It's ${resultEmoji} ${result}! You won $${profit}.`;
                color = '#00ff00';
            } else {
                finalMessage = `LOST! It's ${resultEmoji} ${result}. You lost $${cfCurrentBet}.`;
                color = 'red';
            }
            
            showCfMessage(finalMessage, color);
            
            cfCurrentBet = 0;
            cfChoice = null;
            cfChoiceDisplay.textContent = 'None';
            cfBetInput.disabled = false;
            cfHeadsBtn.classList.remove('bet-on-horse');
            cfTailsBtn.classList.remove('bet-on-horse');
            document.getElementById('coin').textContent = 'ü™ô'; // Reset coin symbol

            updateCoinFlipState();
            document.getElementById('back-to-menu-cf').disabled = false;
        }

        function initializeCoinFlip() {
            cfBetInput = document.getElementById('cf-bet-input');
            cfHeadsBtn = document.getElementById('cf-bet-heads');
            cfTailsBtn = document.getElementById('cf-bet-tails');
            cfFlipBtn = document.getElementById('cf-flip-button');
            cfMessageDiv = document.getElementById('message-cf');
            cfChoiceDisplay = document.getElementById('cf-choice-display');
            
            cfCurrentBet = 0;
            cfChoice = null;
            cfBetInput.value = Math.min(10, currentBalance);
            document.getElementById('coin').style.opacity = 1;
            document.getElementById('coin').textContent = 'ü™ô'; // Ensure reset

            cfHeadsBtn.onclick = () => placeCoinFlipBet('Heads');
            cfTailsBtn.onclick = () => placeCoinFlipBet('Tails');
            cfFlipBtn.onclick = flipCoin;
            
            updateCoinFlipState();
            showCfMessage("Place your bet and choose Heads (üêº) or Tails (üéã)!");
        }

        // --- NEW GAME LOGIC: PANDA FIGHTING (BRAWLERS) ---
        let pfBetInput, pfFightBtn, pfMessageDiv;
        let pfCurrentBet = 0;
        let pfChosenBrawler = null;

        const brawlers = {
            'Panda Smash': 'ü•ä',
            'Bamboo Fury': 'ü•ã'
        };

        function updatePandaFightingState() {
            pfFightBtn.disabled = pfCurrentBet === 0 || currentBalance < pfCurrentBet;
            document.querySelectorAll('.brawler').forEach(btn => {
                btn.classList.toggle('chosen', btn.dataset.brawler === pfChosenBrawler);
                btn.disabled = pfCurrentBet > 0 || currentBalance < MIN_BET;
            });
            if (currentBalance < MIN_BET) showPfMessage("Out of funds! Go talk to Fluff.", 'red');
            pfBetInput.max = currentBalance;
        }

        function showPfMessage(msg, color = '#ffde59') {
            if (pfMessageDiv) { pfMessageDiv.textContent = msg; pfMessageDiv.style.color = color; }
        }

        function placePandaBet(brawlerName) {
            const bet = parseInt(pfBetInput.value);
            if (isNaN(bet) || bet < MIN_BET || bet > currentBalance) { showPfMessage(`Invalid bet! Min $${MIN_BET}.`, 'red'); return; }

            if (pfCurrentBet > 0) { setGameState(currentBalance + pfCurrentBet, lastLoanTime); pfCurrentBet = 0; }
            
            pfCurrentBet = bet;
            pfChosenBrawler = brawlerName;
            setGameState(currentBalance - pfCurrentBet, lastLoanTime);

            pfBetInput.disabled = true;
            showPfMessage(`$${pfCurrentBet} placed on ${brawlerName}!`);
            updatePandaFightingState();
        }

        async function startPandaFight() {
            if (pfCurrentBet === 0) return;

            pfFightBtn.disabled = true;
            document.getElementById('back-to-menu-pf').disabled = true;
            showPfMessage("The brawlers enter the ring...", '#ccc');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const brawlerNames = Object.keys(brawlers);
            const winningBrawler = brawlerNames[Math.floor(Math.random() * brawlerNames.length)];

            // Animation/Message sequence
            showPfMessage(`Brawl in progress! ${brawlers['Panda Smash']} vs ${brawlers['Bamboo Fury']}...`, '#ffde59');
            await new Promise(resolve => setTimeout(resolve, 2500));
            showPfMessage(`And the winner is... ${winningBrawler}!`, '#00ff00');
            
            let winAmount = 0;
            let finalMessage;
            let color;
            
            if (winningBrawler === pfChosenBrawler) {
                winAmount = pfCurrentBet * 2;
                setGameState(currentBalance + winAmount, lastLoanTime);
                const profit = winAmount - pfCurrentBet;
                finalMessage = `VICTORY! ${winningBrawler} wins! You won $${profit}.`;
                color = '#00ff00';
            } else {
                finalMessage = `DEFEAT! ${winningBrawler} prevails. You lost $${pfCurrentBet}.`;
                color = 'red';
            }

            // Final state reset
            pfCurrentBet = 0;
            pfChosenBrawler = null;
            pfBetInput.disabled = false;
            pfBetInput.value = Math.min(10, currentBalance);
            
            updatePandaFightingState();
            pfFightBtn.disabled = false;
            document.getElementById('back-to-menu-pf').disabled = false;
            showPfMessage(finalMessage, color);
        }

        function initializePandaFighting() {
            pfBetInput = document.getElementById('pf-bet-input');
            pfFightBtn = document.getElementById('pf-fight-button');
            pfMessageDiv = document.getElementById('message-pf');
            
            pfCurrentBet = 0;
            pfChosenBrawler = null;
            pfBetInput.value = Math.min(10, currentBalance);

            document.getElementById('brawler-1').onclick = () => placePandaBet('Panda Smash');
            document.getElementById('brawler-2').onclick = () => placePandaBet('Bamboo Fury');
            pfFightBtn.onclick = startPandaFight;

            updatePandaFightingState();
            showPfMessage("Choose your champion and place your bet!");
        }

        // --- NEW GAME LOGIC: POKER (SIMPLIFIED TEXAS HOLD'EM) ---
        const POKER_DECK = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'].flatMap(rank => 
                           ['H', 'D', 'C', 'S'].map(suit => rank + suit));
        const POKER_ANTE = 10;
        const POKER_BET = 20;
        
        let pokerDeck, playerHandPoker, dealerHandPoker, communityCards;
        let pokerPot = 0;
        let pokerStage = 'ante';
        
        let pokerBetInput, pokerDealBtn, pokerFoldBtn, pokerBetCallBtn, pokerMessageDiv;

        function updatePokerState() {
             const canAffordAnte = currentBalance >= POKER_ANTE;
             const canAffordBet = currentBalance >= POKER_BET;

             pokerBetInput.max = currentBalance;
             document.getElementById('poker-ante').textContent = POKER_ANTE;
             document.getElementById('current-pot-poker').textContent = pokerPot;

             if (pokerStage === 'ante') {
                pokerBetInput.disabled = !canAffordAnte;
                pokerDealBtn.disabled = !canAffordAnte;
                pokerFoldBtn.disabled = true;
                pokerBetCallBtn.disabled = true;
                document.getElementById('poker-controls').style.display = 'none';
                document.getElementById('poker-betting-controls').style.display = 'block';
                if (!canAffordAnte) showPokerMessage("Out of funds! Go talk to Fluff.", 'red');
                pokerDealBtn.textContent = `Place Ante ($${POKER_ANTE}) & Deal`;
             } else if (pokerStage === 'preflop') {
                pokerBetInput.disabled = true;
                pokerDealBtn.disabled = true;
                pokerFoldBtn.disabled = false;
                pokerBetCallBtn.disabled = !canAffordBet;
                document.getElementById('poker-controls').style.display = 'flex';
                document.getElementById('poker-betting-controls').style.display = 'none';
                pokerBetCallBtn.textContent = `CALL/BET (Total: $${POKER_BET})`;
             } else {
                pokerBetInput.disabled = true;
                pokerDealBtn.disabled = false;
                pokerFoldBtn.disabled = true;
                pokerBetCallBtn.disabled = true;
                document.getElementById('poker-controls').style.display = 'none';
                document.getElementById('poker-betting-controls').style.display = 'block';
                pokerDealBtn.textContent = `Play Again (Ante $${POKER_ANTE})`;
             }
        }
        
        function showPokerMessage(msg, color = '#ffde59') {
            if (pokerMessageDiv) { pokerMessageDiv.textContent = msg; pokerMessageDiv.style.color = color; }
        }

        function dealPokerCard(hand, isHidden = false) {
            if (pokerDeck.length === 0) return null;
            const card = pokerDeck.pop();
            hand.push(card);
            return card;
        }

        function renderPokerHand(hand, element, hideAll = false, isCommunity = false) {
            element.innerHTML = '';
            hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = isCommunity ? 'card community-card' : 'card';
                
                if (hideAll) {
                    cardDiv.classList.add('hidden');
                    cardDiv.textContent = 'üÇ†';
                } else {
                    const rank = card.slice(0, -1);
                    const suit = card.slice(-1);
                    const suitEmoji = { 'H': '‚ô•Ô∏è', 'D': '‚ô¶Ô∏è', 'C': '‚ô£Ô∏è', 'S': '‚ô†Ô∏è' }[suit];
                    cardDiv.textContent = `${rank}${suitEmoji}`;
                    cardDiv.style.color = (suit === 'H' || suit === 'D') ? 'red' : 'black';
                }
                element.appendChild(cardDiv);
            });
        }
        
        async function placeAnteAndDeal() {
            if (currentBalance < POKER_ANTE) return;

            pokerDeck = [...POKER_DECK].sort(() => Math.random() - 0.5);
            playerHandPoker = [];
            dealerHandPoker = [];
            communityCards = [];
            pokerPot = 0;
            pokerStage = 'preflop';
            pokerMessageDiv.textContent = '';
            document.getElementById('player-hand-rank').textContent = '?';
            document.getElementById('dealer-hand-rank').textContent = '?';

            setGameState(currentBalance - POKER_ANTE, lastLoanTime);
            pokerPot += POKER_ANTE;

            dealPokerCard(playerHandPoker); dealPokerCard(dealerHandPoker, true);
            dealPokerCard(playerHandPoker); dealPokerCard(dealerHandPoker, true);
            
            dealPokerCard([]);
            for(let i = 0; i < 3; i++) dealPokerCard(communityCards);

            renderPokerHand(playerHandPoker, document.getElementById('player-cards-poker'));
            renderPokerHand(dealerHandPoker, document.getElementById('dealer-cards-poker'), true);
            renderPokerHand(communityCards, document.getElementById('community-cards'), false, true);

            showPokerMessage("Ante paid. Your hand is dealt. Call/Bet or Fold?", '#ffde59');
            updatePokerState();
            document.getElementById('back-to-menu-poker').disabled = true;
        }
        
        function fold() {
            pokerStage = 'showdown';
            showPokerMessage(`Folded! You lose your ante ($${POKER_ANTE}). Better luck next time.`, 'red');
            updatePokerState();
            document.getElementById('back-to-menu-poker').disabled = false;
        }

        async function callBet() {
            if (currentBalance < POKER_BET) return;

            setGameState(currentBalance - POKER_BET, lastLoanTime);
            pokerPot += POKER_BET;

            showPokerMessage(`Called/Bet $${POKER_BET}! Now for the Turn and River...`, '#ffde59');
            document.getElementById('poker-controls').style.display = 'none';

            await new Promise(resolve => setTimeout(resolve, 1500));
            dealPokerCard([]);
            dealPokerCard(communityCards);
            renderPokerHand(communityCards, document.getElementById('community-cards'), false, true);

            await new Promise(resolve => setTimeout(resolve, 1500));
            dealPokerCard([]);
            dealPokerCard(communityCards);
            renderPokerHand(communityCards, document.getElementById('community-cards'), false, true);

            await new Promise(resolve => setTimeout(resolve, 1500));
            showdown();
        }

        function getHandRank(hand) {
            // Simplified ranker: maps ranks to numeric value for comparison
            const ranks = hand.map(c => c.slice(0, -1));
            const highCard = ranks.map(r => ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'].indexOf(r)).sort((a, b) => b - a)[0];
            const highCardName = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'][highCard];
            return { rankValue: highCard, name: `High Card ${highCardName}` };
        }


        function showdown() {
            pokerStage = 'showdown';
            renderPokerHand(dealerHandPoker, document.getElementById('dealer-cards-poker'));
            
            const playerResult = getHandRank(playerHandPoker);
            const dealerResult = getHandRank(dealerHandPoker);

            document.getElementById('player-hand-rank').textContent = playerResult.name;
            document.getElementById('dealer-hand-rank').textContent = dealerResult.name;

            let outcome;
            if (playerResult.rankValue > dealerResult.rankValue) {
                outcome = 'win';
            } else if (dealerResult.rankValue > playerResult.rankValue) {
                outcome = 'loss';
            } else {
                outcome = 'push';
            }

            let winAmount = 0;
            let finalMessage;
            let color;
            
            if (outcome === 'win') {
                winAmount = pokerPot * 2;
                setGameState(currentBalance + winAmount, lastLoanTime);
                finalMessage = `PLAYER WINS! You win the $${pokerPot} pot!`;
                color = '#00ff00';
            } else if (outcome === 'loss') {
                finalMessage = `DEALER WINS! You lose the $${pokerPot} pot.`;
                color = 'red';
            } else {
                winAmount = pokerPot;
                setGameState(currentBalance + winAmount, lastLoanTime);
                finalMessage = "CHOP! It's a tie, your money is returned.";
                color = '#ffde59';
            }
            
            pokerPot = 0;
            showPokerMessage(finalMessage, color);
            updatePokerState();
            document.getElementById('back-to-menu-poker').disabled = false;
        }

        function initializePoker() {
            pokerBetInput = document.getElementById('poker-bet-input');
            pokerDealBtn = document.getElementById('poker-deal-button');
            pokerFoldBtn = document.getElementById('poker-fold');
            pokerBetCallBtn = document.getElementById('poker-bet-call');
            pokerMessageDiv = document.getElementById('message-poker');

            pokerBetInput.value = POKER_ANTE;
            pokerPot = 0;
            pokerStage = 'ante';
            document.getElementById('player-cards-poker').innerHTML = '';
            document.getElementById('dealer-cards-poker').innerHTML = '';
            document.getElementById('community-cards').innerHTML = '';
            document.getElementById('player-hand-rank').textContent = '?';
            document.getElementById('dealer-hand-rank').textContent = '?';

            pokerDealBtn.onclick = placeAnteAndDeal;
            pokerFoldBtn.onclick = fold;
            pokerBetCallBtn.onclick = callBet;

            updatePokerState();
            showPokerMessage(`Place your ante of $${POKER_ANTE} to deal the hand.`);
        }


        // --- FIREBASE INITIALIZATION AND DATA LOAD ---

        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     console.error("Firebase config is missing. Running in non-persistent mode.");
                     isAuthReady = true;
                     loadingScreen.style.display = 'none';
                     switchView('main-menu');
                     return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in anonymously or with custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be confirmed
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        
                        // Set up the listener for real-time data
                        const docRef = doc(db, GAME_DATA_PATH + userId + '/game_data', GAME_DOC_ID);
                        onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                
                                // Load data if not already initialized or if external change detected
                                if (data.balance !== currentBalance || data.lastLoanTime !== lastLoanTime) {
                                    currentBalance = data.balance;
                                    lastLoanTime = data.lastLoanTime;
                                    updateBalanceDisplay();
                                }
                            } else if (!isAuthReady) {
                                // First time user: set initial balance and save
                                console.log("New player! Initializing game state...");
                                setGameState(500, 0); 
                            }
                            
                            if (!isAuthReady) {
                                isAuthReady = true;
                                loadingScreen.style.display = 'none';
                                switchView('main-menu');
                            }
                        }, (error) => {
                             console.error("Firestore Snapshot Error: ", error);
                             // Fallback to local data if listener fails
                             if (!isAuthReady) {
                                 isAuthReady = true;
                                 loadingScreen.style.display = 'none';
                                 switchView('main-menu');
                             }
                        });

                    } else {
                        console.error("Authentication failed.");
                        isAuthReady = true;
                        loadingScreen.style.display = 'none';
                        switchView('main-menu');
                    }
                });

            } catch (e) {
                console.error("Fatal Firebase Initialization Error:", e);
                // Fallback to non-persistent mode if setup fails
                isAuthReady = true;
                loadingScreen.style.display = 'none';
                switchView('main-menu');
            }
        }


        // --- Global Initialization ---
        window.onload = function() {
            initMenuListeners();
            setupFirebase(); // Start the Firebase auth and data load process
        };

    </script>
</body>
</html>
