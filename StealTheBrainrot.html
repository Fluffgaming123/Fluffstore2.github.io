<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steal The Brainrot Tycoon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1f2937;
            color: #e0e0e0;
            overflow: hidden;
        }

        .game-container {
            background-color: #374151;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        /* Conveyor Belt Styling */
        .conveyor-belt-container { background-color: #4b5563; }
        .conveyor-belt {
            background-image: linear-gradient(45deg, #374151 25%, #4b5563 25%, #4b5563 50%, #374151 50%, #374151 75%, #4b5563 75%, #4b5563 100%);
            background-size: 60px 60px;
            animation: slide 4s linear infinite;
        }
        .paused { animation-play-state: paused; }
        @keyframes slide { from { background-position: 0 0; } to { background-position: -120px 0; } }

        /* Brainrot Items on Belt */
        .belt-item-wrapper {
            position: absolute; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; transition: transform 0.2s ease; user-select: none;
            top: 50%; /* Center vertically */
            transform: translateY(-50%);
        }
        .belt-item-wrapper:hover { transform: scale(1.1) translateY(-50%); z-index: 20; }
        .belt-item-label {
            background-color: rgba(0,0,0,0.8); 
            padding: 2px 6px; /* Reduced padding */
            border-radius: 6px; /* Smaller radius */
            font-size: 10px; /* --- REDUCED FONT SIZE --- */
            margin-bottom: 2px; /* Reduced margin */
            text-align: center;
            line-height: 1.2;
            width: 80px; /* Fixed width to allow wrapping */
            white-space: normal; /* Allow text to wrap */
        }
        .belt-item {
            width: 50px; height: 50px; /* --- REDUCED ITEM SIZE --- */
            font-size: 24px; /* --- REDUCED ICON SIZE --- */
            border-radius: 50%; background-color: rgba(0,0,0,0.5);
            border-width: 2px; /* Thinner border */
            transition: box-shadow 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .belt-item-wrapper:hover .belt-item { box-shadow: 0 0 15px var(--glow-color, #fff); }
        
        /* Base and Slots */
        .base-container { background-color: #4b5563; }
        .base-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); /* Smaller min size */
        }
        .base-slot {
            border: 2px dashed #6b7280; background-color: rgba(0,0,0,0.3); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.2s ease;
            aspect-ratio: 1/1;
            position: relative;
        }
        .base-slot:hover {
            background-color: #4b5563;
        }
        .base-slot.sell-mode:hover {
            background-color: rgba(239, 68, 68, 0.4); border-color: #ef4444;
        }
        .base-item {
             width: 80%; height: 80%; font-size: 22px; /* Reduced base icon size */
             border-radius: 50%;
             pointer-events: none;
             position: relative;
             display: flex;
             align-items: center;
             justify-content: center;
        }
        .mutation-icon, .trait-icon {
            position: absolute;
            width: 18px; /* Smaller icons */
            height: 18px; /* Smaller icons */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px; /* Smaller font */
            font-weight: bold;
            border: 1px solid #fff;
            user-select: none;
            z-index: 1; /* Make sure icon is on top */
        }
        .mutation-icon { top: -5px; left: -5px; } /* Offset to corner */
        .trait-icon { bottom: -5px; right: -5px; font-size: 14px; } /* Offset to corner */

        /* Buttons */
        .btn {
            padding: 6px 12px; /* Reduced button padding */
            border-radius: 8px; font-weight: 600;
            transition: all 0.2s ease; border: none;
            font-size: 12px; /* Smaller button font */
        }
        .btn-blue { background-color: #3b82f6; color: white; }
        .btn-blue:hover { background-color: #2563eb; }
        .btn-green { background-color: #22c55e; color: white; }
        .btn-green:hover { background-color: #16a34a; }
        .btn-gray { background-color: #6b7280; color: white; }
        .btn-gray:hover { background-color: #4b5563; }
        .btn-purple { background-color: #8b5cf6; color: white; }
        .btn-purple:hover:not(:disabled) { background-color: #7c3aed; }
        .btn-purple:disabled { background-color: #6b7280; color: #d1d5db; cursor: not-allowed; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover:not(:disabled) { background-color: #dc2626; }
        .btn-yellow { background-color: #eab308; color: white; }
        .btn-yellow:hover:not(:disabled) { background-color: #ca8a04; }
        .btn-cyan { background-color: #06b6d4; color: white; }
        .btn-cyan:hover:not(:disabled) { background-color: #0891b2; }
        .btn-orange { background-color: #f97316; color: white; }
        .btn-orange:hover:not(:disabled) { background-color: #ea580c; }
        .btn-pink { background-color: #ec4899; color: white; }
        .btn-pink:hover:not(:disabled) { background-color: #db2777; }
        .btn.active { box-shadow: inset 0 0 10px rgba(0,0,0,0.5); transform: scale(0.95); }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #374151; border-radius: 16px;
            width: 90%; max-width: 1000px; max-height: 90vh;
            padding: 24px; display: flex; flex-direction: column;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
        }
        .small-modal-content {
             max-width: 500px;
             max-height: auto;
        }
        .index-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px; padding: 16px;
        }
        .index-item {
            background-color: #374151; border-radius: 8px;
            padding: 8px; aspect-ratio: 1/1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; border: 2px solid #6b7280;
        }
        .index-item.undiscovered { background-color: #1f2937; color: #6b7280; }
        .index-item-icon { font-size: 32px; }
        .index-item-name { font-size: 12px; margin-top: 4px; font-weight: 600;}
        .requirement-met { color: #4ade80; }
        .requirement-not-met { color: #f87171; }
        
        /* Admin Panel */
        .admin-input { /* Keep class name for styling */
            background-color: #4b5563; color: white;
            border: 1px solid #6b7280; border-radius: 6px;
            padding: 4px 8px;
        }
        .admin-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .admin-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        /* Notification */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 2000;
            border: 2px solid;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, top 0.3s;
        }

        /* Loading Spinner */
        #loading-spinner {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border: 8px solid #4b5563;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            z-index: 9999;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-sm sm:text-base">

    <div id="loading-spinner"></div>
    <div id="game-root" class="game-container w-full max-w-6xl h-[95vh] p-4 rounded-2xl flex flex-col gap-2 hidden">
        <!-- Header, Info Bar, Game Area... -->
        <header class="flex flex-wrap justify-between items-center pb-1">
            <h1 class="text-xl sm:text-2xl font-bold text-white">Steal The Brainrot</h1>
            <nav class="flex items-center gap-2 sm:gap-3 flex-wrap">
                <button id="pause-button" class="btn btn-blue">Pause</button>
                <button id="save-button" class="btn btn-green">Save</button>
                <button id="load-button" class="btn btn-green hidden">Load File</button>
                <button id="index-button" class="btn btn-gray">Index <span id="index-counter">(0/0)</span></button>
                <button id="open-rebirth-button" class="btn btn-purple">Rebirth</button>
            </nav>
        </header>
        <div class="flex justify-between items-center bg-gray-800 p-2 rounded-lg">
            <div>
                <div class="text-lg font-bold text-green-400">Money: $<span id="money">100</span></div>
                <div class="text-xs text-gray-400">per second: $<span id="mps">0</span></div>
            </div>
            <div class="text-center">
                <div class="text-base font-semibold text-yellow-300">Next spawn in: <span id="timer-display">00:00</span></div>
                <div id="active-events-list" class="flex gap-1 justify-center mt-1 h-4"></div>
                <div class="text-xs text-gray-400">Rebirths: <span id="rebirth-display">0</span></div>
            </div>
            <div class="text-lg font-semibold text-gray-300">
                Base: <span id="base-count">0 / 10</span>
            </div>
        </div>
        
        <!-- Fuse Button Bar -->
        <div class="flex gap-2 justify-center flex-wrap">
            <button id="open-normal-fuse-button" class="btn btn-cyan">Fuse</button>
            <button id="open-witch-fuse-button" class="btn btn-pink">Witch Fuse</button>
            <button id="open-taco-fuse-button" class="btn btn-yellow hidden">Taco Fuse</button>
            <button id="open-craft-machine-button" class="btn btn-orange">Craft</button>
            <button id="open-ritual-button" class="btn btn-red">Ritual</button>
            <button id="open-dealer-button" class="btn btn-green">Dealer</button>
        </div>

        <main class="flex-grow flex flex-col gap-2 overflow-hidden">
            <div id="conveyor-belt" class="h-1/3 conveyor-belt-container rounded-lg relative overflow-hidden"></div>
            <div class="h-2/3 flex flex-col base-container p-2 rounded-lg">
                <div class="flex justify-between items-center mb-1">
                    <h2 class="text-lg font-bold text-white">Your Base</h2>
                    <div class="flex gap-2">
                        <button id="sell-button" class="btn btn-blue">Sell</button>
                    </div>
                </div>
                <div id="base" class="base-grid gap-2 sm:gap-2 flex-grow p-2 rounded-md overflow-y-auto">
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="index-modal" class="modal-overlay hidden"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Brainrot Index</h2><button id="close-index-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="index-grid-container" class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-2"></div></div></div>
    <div id="rebirth-modal" class="modal-overlay hidden"><div class="modal-content small-modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Rebirth</h2><button id="close-rebirth-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="rebirth-info" class="bg-gray-800 rounded-lg p-4 space-y-3"></div><div class="mt-6 flex flex-col items-center"><p class="text-center text-gray-400 mb-2">Rewards: +1 Base Slot, +2% MPS, +Slight Luck</p><button id="confirm-rebirth-button" class="btn btn-purple text-lg w-full" disabled>Confirm Rebirth</button></div></div></div>
    <div id="jayce-modal" class="modal-overlay hidden">
        <div class="modal-content small-modal-content overflow-y-auto">
             <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Jayce Panel</h2><button id="close-jayce-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div>
             <div id="jayce-password-screen"><p class="mb-2">Enter Jayce's Password:</p><input type="password" id="jayce-password-input" class="admin-input w-full mb-2"><button id="jayce-login-button" class="btn btn-blue w-full">Login</button><p id="jayce-error" class="text-red-500 text-sm mt-2"></p></div>
             <div id="jayce-command-screen" class="hidden space-y-4">
                <div class="flex items-center gap-2"><input id="jayce-chat-input" placeholder="Global Jayce Message" class="admin-input flex-grow"><button id="jayce-send-chat" class="btn btn-blue">Send</button></div>
                <hr class="border-gray-600">
                <div class="flex items-center gap-2"><input type="number" id="jayce-money-input" placeholder="Amount of money" class="admin-input flex-grow"><button id="jayce-give-money" class="btn btn-green">Give (Self)</button></div>
                <div class="admin-grid-2"><select id="jayce-spawn-mutation" class="admin-input"></select><select id="jayce-spawn-trait" class="admin-input"></select></div>
                <div class="flex items-center gap-2"><select id="jayce-spawn-select" class="admin-input flex-grow"></select><button id="jayce-spawn-button" class="btn btn-blue">Spawn (Global)</button></div>
                <div class="admin-grid-2"><select id="jayce-give-mutation" class="admin-input"></select><select id="jayce-give-trait" class="admin-input"></select></div>
                <div class="flex items-center gap-2"><select id="jayce-give-select" class="admin-input flex-grow"></select><button id="jayce-give-button" class="btn btn-blue">Give (Self)</button></div>
                <div class="flex items-center gap-2"><input type="number" id="jayce-rebirth-input" placeholder="Rebirth Level" class="admin-input flex-grow"><button id="jayce-give-rebirth" class="btn btn-purple">Set (Self)</button></div>
                <div class="flex items-center gap-2"><input type="number" id="jayce-luck-input" placeholder="Additional Luck" class="admin-input flex-grow"><button id="jayce-give-luck" class="btn btn-purple">Add (Self)</button></div>
                <button id="jayce-unlock-index" class="btn btn-gray w-full">Unlock Index (Self)</button>
                <hr class="border-gray-600">
                <h3 class="text-lg font-bold">Dealer Restock</h3>
                <div class="flex items-center gap-2">
                    <select id="jayce-restock-select" class="admin-input flex-grow"></select>
                    <button id="jayce-restock-button" class="btn btn-green">Restock Global</button>
                </div>
                <hr class="border-gray-600">
                <h3 class="text-lg font-bold">Global Events</h3>
                <div class="admin-grid-2">
                    <select id="jayce-event-select" class="admin-input"></select>
                    <button id="jayce-event-run-global" class="btn btn-blue">Run Global</button>
                </div>
                <div class="admin-grid-3"><button id="jayce-event-taco" class="btn btn-yellow">Taco Time</button><button id="jayce-event-run-all" class="btn btn-green">Run All</button><button id="jayce-event-stop-all" class="btn btn-red">Stop All</button></div>
                <button id="jayce-logout-button" class="btn btn-gray w-full">Logout</button>
             </div>
        </div>
    </div>
    <div id="ritual-modal" class="modal-overlay hidden"><div class="modal-content small-modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Rituals</h2><button id="close-ritual-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="ritual-list" class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-4 space-y-4"></div></div></div>
    <div id="craft-machine-modal" class="modal-overlay hidden"><div class="modal-content small-modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Crafting</h2><button id="close-craft-machine-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="craft-machine-list" class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-4 space-y-4"></div></div></div>
    <div id="fuse-modal" class="modal-overlay hidden"><div class="modal-content small-modal-content"><div class="flex justify-between items-center mb-4"><h2 id="fuse-modal-title" class="text-2xl font-bold">Fuse</h2><button id="close-fuse-modal-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="fuse-modal-list" class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-4 space-y-4"></div></div></div>
    <div id="dealer-modal" class="modal-overlay hidden"><div class="modal-content small-modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Brainrot Dealer</h2><button id="close-dealer-button" class="text-3xl font-bold leading-none px-2 rounded-full hover:bg-gray-600">&times;</button></div><div id="dealer-list" class="flex-grow overflow-y-auto bg-gray-800 rounded-lg p-4 space-y-4"></div></div></div>
    
    <!-- Global UI -->
    <div id="global-tooltip" class="hidden fixed bg-black bg-opacity-80 text-white text-xs rounded-md p-2 pointer-events-none z-[9999]"></div>
    <div id="notification"></div>
    <input type="file" id="load-file-input" accept=".json" class="hidden">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, collection, 
            query, where, onSnapshot, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const gameRoot = document.getElementById('game-root');
        const pauseButton = document.getElementById('pause-button');
        const saveButton = document.getElementById('save-button');
        const loadButton = document.getElementById('load-button');
        const indexButton = document.getElementById('index-button');
        const indexCounter = document.getElementById('index-counter');
        const openRebirthButton = document.getElementById('open-rebirth-button');
        const moneyDisplay = document.getElementById('money');
        const mpsDisplay = document.getElementById('mps');
        const timerDisplay = document.getElementById('timer-display');
        const activeEventsList = document.getElementById('active-events-list');
        const rebirthDisplay = document.getElementById('rebirth-display');
        const baseCountDisplay = document.getElementById('base-count');
        const openNormalFuseButton = document.getElementById('open-normal-fuse-button');
        const openWitchFuseButton = document.getElementById('open-witch-fuse-button');
        const openTacoFuseButton = document.getElementById('open-taco-fuse-button');
        const openCraftMachineButton = document.getElementById('open-craft-machine-button');
        const openRitualButton = document.getElementById('open-ritual-button');
        const openDealerButton = document.getElementById('open-dealer-button');
        const conveyorBelt = document.getElementById('conveyor-belt');
        const baseContainer = document.getElementById('base');
        const sellButton = document.getElementById('sell-button');
        const indexModal = document.getElementById('index-modal');
        const closeIndexButton = document.getElementById('close-index-button');
        const indexGridContainer = document.getElementById('index-grid-container');
        const rebirthModal = document.getElementById('rebirth-modal');
        const closeRebirthButton = document.getElementById('close-rebirth-button');
        const rebirthInfo = document.getElementById('rebirth-info');
        const confirmRebirthButton = document.getElementById('confirm-rebirth-button');
        const jayceModal = document.getElementById('jayce-modal');
        const closeJayceButton = document.getElementById('close-jayce-button');
        const jaycePasswordScreen = document.getElementById('jayce-password-screen');
        const jaycePasswordInput = document.getElementById('jayce-password-input');
        const jayceLoginButton = document.getElementById('jayce-login-button');
        const jayceError = document.getElementById('jayce-error');
        const jayceCommandScreen = document.getElementById('jayce-command-screen');
        const jayceLogoutButton = document.getElementById('jayce-logout-button');
        const ritualModal = document.getElementById('ritual-modal');
        const closeRitualButton = document.getElementById('close-ritual-button');
        const ritualList = document.getElementById('ritual-list');
        const craftMachineModal = document.getElementById('craft-machine-modal');
        const closeCraftMachineButton = document.getElementById('close-craft-machine-button');
        const craftMachineList = document.getElementById('craft-machine-list');
        const fuseModal = document.getElementById('fuse-modal');
        const fuseModalTitle = document.getElementById('fuse-modal-title');
        const closeFuseModalButton = document.getElementById('close-fuse-modal-button');
        const fuseModalList = document.getElementById('fuse-modal-list');
        const dealerModal = document.getElementById('dealer-modal');
        const closeDealerButton = document.getElementById('close-dealer-button');
        const dealerList = document.getElementById('dealer-list');
        const globalTooltip = document.getElementById('global-tooltip');
        const notification = document.getElementById('notification');
        const loadFileInput = document.getElementById('load-file-input');

        // --- Data Definitions ---
        const SELL_MULTIPLIER = 0.5;
        const rarities = {
            'Common':       { color: '#9ca3af', weight: 900, glow: '#9ca3af' },
            'Rare':         { color: '#2563eb', weight: 80, glow: '#2563eb' },
            'Epic':         { color: '#9333ea', weight: 60, glow: '#9333ea' },
            'Legendary':    { color: '#f97316', weight: 40, glow: '#f97316' },
            'Mythic':       { color: '#ef4444', weight: 35, glow: '#ef4444' },
            'Brainrot God': { color: '#fde047', weight: 5, glow: '#fde047' },
            'Secret':       { color: '#ffffff', weight: 1, glow: '#a855f7' },
            'OG':           { color: '#ff00ff', weight: 0.1, glow: '#ff00ff' },
            'Lucky Block':  { color: '#facc15', weight: 3, glow: '#facc15' } 
        };

        const mutations = {
            'None': { name: 'None', multiplier: 1 },
            'Gold': { name: 'Gold', icon: 'G', color: '#fde047', multiplier: 1.5, chance: 0.05 },
            'Diamond': { name: 'Diamond', icon: 'D', color: '#3b82f6', multiplier: 3, chance: 0.02 },
            'Rainbow': { name: 'Rainbow', icon: 'R', color: 'linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet)', multiplier: 7, chance: 0.005 }
        };

        const weatherEvents = {
            'Meowl': { name: 'Meowl', duration: 300, multiplier: 7, icon: 'ğŸ±', color: '#fb923c' },
            'Witching Hour': { name: 'Witching Hour', duration: 300, multiplier: 4.5, icon: 'ğŸ§™', color: '#a855f7' },
            'Rain': { name: 'Rain', duration: 300, multiplier: 2.5, icon: 'ğŸŒ§ï¸', color: '#60a5fa' },
            'Snowy': { name: 'Snowy', duration: 300, multiplier: 3, icon: 'â„ï¸', color: '#ffffff' },
            'Starfall': { name: 'Starfall', duration: 300, multiplier: 3.5, icon: 'â­', color: '#facc15' },
            'Hat': { name: 'Hat', duration: 300, multiplier: 4.5, icon: 'ğŸ©', color: '#374151' },
            'Water': { name: 'Water', duration: 300, multiplier: 4, icon: 'ğŸ’§', color: '#3b82f6' },
            'Galactic': { name: 'Galactic', duration: 300, multiplier: 4, icon: 'ğŸŒŒ', color: '#6d28d9' },
            'Bombardiro': { name: 'Bombardiro', duration: 300, multiplier: 4, icon: 'ğŸ’£', color: '#ef4444' },
            'Extinct': { name: 'Extinct', duration: 300, multiplier: 4, icon: 'â˜„ï¸', color: '#f97316' },
            'Spider': { name: 'Spider', duration: 300, multiplier: 4.5, icon: 'ğŸ•·ï¸', color: '#4b5563' },
            'Paint': { name: 'Paint', duration: 300, multiplier: 6, icon: 'ğŸ¨', color: '#ec4899' },
            'Tie': { name: 'Tie', duration: 300, multiplier: 4.75, icon: 'ğŸ‘”', color: '#14b8a6' },
            'Strawberry': { name: 'Strawberry', duration: 300, multiplier: 8, icon: 'ğŸ“', color: '#f43f5e' },
            'Taco': { name: 'Taco', duration: 300, multiplier: 3, icon: 'ğŸŒ®', color: '#f59e0b' },
            'Tung Tung Attack': { name: 'Tung Tung Attack', duration: 300, multiplier: 5, icon: 'ğŸ¶', color: '#fde047' },
            'Indonesia': { name: 'Indonesia', duration: 300, multiplier: 2, icon: 'ğŸ‡®ğŸ‡©', color: '#ef4444' },
            'Crab Rave': { name: 'Crab Rave', duration: 300, multiplier: 5, icon: 'ğŸ¦€', color: '#f97316' },
            'Rap Concert': { name: 'Rap Concert', duration: 300, multiplier: 5, icon: 'ğŸ¤', color: '#a855f7' },
            'Mexico': { name: 'Mexico', duration: 300, multiplier: 5, icon: 'ğŸ‡²ğŸ‡½', color: '#22c55e' },
            'Glitch': { name: 'Glitch', duration: 300, multiplier: 6, icon: 'ğŸ‘¾', color: '#ec4899' },
            'Fire': { name: 'Fire', duration: 300, multiplier: 6, icon: 'ğŸ”¥', color: '#f97316' },
            'Fireworks': { name: 'Fireworks', duration: 300, multiplier: 6, icon: 'ğŸ†', color: '#f43f5e' },
            'Nyan': { name: 'Nyan', duration: 300, multiplier: 6, icon: 'ğŸŒˆ', color: '#3b82f6' },
            '10B': { name: '10B', duration: 300, multiplier: 4, icon: 'ğŸ”Ÿ', color: '#fde047' },
            'Bloodmoon': { name: 'Bloodmoon', duration: 300, multiplier: 4, icon: 'ğŸ©¸', color: '#dc2626' },
            'Brazil': { name: 'Brazil', duration: 300, multiplier: 6, icon: 'ğŸ‡§ğŸ‡·', color: '#22c55e' },
            'Bubblegum': { name: 'Bubblegum', duration: 300, multiplier: 4, icon: 'ğŸ¬', color: '#ec4899' },
            'Bloodrot': { name: 'Bloodrot', duration: 300, multiplier: 2, icon: 'ğŸ¦‡', color: '#7f1d1d' },
            'Candy': { name: 'Candy', duration: 300, multiplier: 4, icon: 'ğŸ­', color: '#f472b6' },
            'Lava': { name: 'Lava', duration: 300, multiplier: 6, icon: 'ğŸŒ‹', color: '#f97316' },
            'Galaxy': { name: 'Galaxy', duration: 300, multiplier: 7, icon: 'âœ¨', color: '#6d28d9' },
            'YinYang': { name: 'YinYang', duration: 300, multiplier: 7.5, icon: 'â˜¯ï¸', color: '#ffffff' },
            'UFO': { name: 'UFO', duration: 300, multiplier: 3, icon: 'ğŸ›¸', color: '#84cc16' },
            'Sleepy': { name: 'Sleepy', duration: 300, multiplier: 0.5, icon: 'ğŸ˜´', color: '#6b7280' },
            '2x Luck': { name: '2x Luck', duration: 900, multiplier: 1, luck: 2, icon: 'ğŸ€' },
            '4x Luck': { name: '4x Luck', duration: 900, multiplier: 1, luck: 4, icon: 'ğŸ€' },
            '6x Luck': { name: '6x Luck', duration: 300, multiplier: 1, luck: 6, icon: 'ğŸ€' },
            '8x Luck': { name: '8x Luck', duration: 300, multiplier: 1, luck: 8, icon: 'ğŸ€' },
            '10x Luck': { name: '10x Luck', duration: 300, multiplier: 1, luck: 10, icon: 'ğŸ€' },
            '999x Luck': { name: '999x Luck', duration: 5, multiplier: 1, luck: 999, icon: 'ğŸ€' },
            'Fuse Luck': { name: 'Fuse Luck', duration: 900, multiplier: 1, luck: 5, icon: 'âš™ï¸' },
            'Witch Luck': { name: 'Witch Luck', duration: 900, multiplier: 1, luck: 5, icon: 'ğŸ”®' },
            'Rainbow Machine': { name: 'Rainbow Machine', duration: 300, multiplier: 1, rainbow: true, icon: 'ğŸŒˆ' },
            'Matteo': { name: 'Matteo', duration: 1, multiplier: 1, spawn: 'Matteo', icon: 'ğŸ‘¨â€ğŸ¦±' }
        };

        const brainrotManifest = {
            'Common': [
                { name: 'Noobini Pizzanini', icon: 'ğŸ•', cost: 10, mps: 1 }, { name: 'LirilÃ¬ LarilÃ ', icon: 'ğŸµ', cost: 12, mps: 1.2 }, 
                { name: 'Tim Cheese', icon: 'ğŸ§€', cost: 15, mps: 1.5 }, { name: 'Fluriflura', icon: 'ğŸŒ¸', cost: 18, mps: 1.9 }, 
                { name: 'Talpa Di Fero', icon: 'ğŸ”©', cost: 22, mps: 2.3 }, { name: 'Svinina Bombardino', icon: 'ğŸ’£', cost: 25, mps: 2.6 }, { name: 'Pipi Kiwi', icon: 'ğŸ¥', cost: 30, mps: 3.1 },
                { name: 'Pipi Corni', icon: 'ğŸŒ½', cost: 32, mps: 3.3 }, { name: 'Pipi Avocado', icon: 'ğŸ¥‘', cost: 35, mps: 3.5 },
                { name: 'Tartaragno', icon: 'ğŸ•·ï¸', cost: 40, mps: 4 }
            ],
            'Rare': [
                { name: 'Trippi Troppi', icon: 'ğŸ˜µ', cost: 250, mps: 20 }, { name: 'Gangster Footera', icon: 'âš½', cost: 275, mps: 22 }, 
                { name: 'Bandito Bobritto', icon: 'ğŸ¤ ', cost: 300, mps: 25 }, { name: 'Boneca Ambalabu', icon: 'ğŸ’ƒ', cost: 330, mps: 28 }, 
                { name: 'Cacto Hipopotamo', icon: 'ğŸŒµ', cost: 360, mps: 32 }, { name: 'Ta Ta Ta Ta Sahur', icon: 'ğŸ¥', cost: 400, mps: 36 }, { name: 'Tric-Trac-Baraboom', icon: 'ğŸ’¥', cost: 450, mps: 41 },
                { name: 'Matteo', icon: 'ğŸ‘¨â€ğŸ¦±', cost: 500, mps: 45 }, { name: 'Pinealotto Fruttarino', icon: 'ğŸ', cost: 550, mps: 50 }
            ],
            'Epic': [
                { name: 'Cappuccino Assassino', icon: 'â˜•', cost: 1000, mps: 100 }, { name: 'Brr Brr Patapim', icon: 'ğŸ¥¶', cost: 1100, mps: 110 }, 
                { name: 'Avocadini Antilopini', icon: 'ğŸ¥‘', cost: 1200, mps: 122 }, { name: 'Trulimero Trulicina', icon: 'ğŸ”', cost: 1300, mps: 135 }, 
                { name: 'Bambini Crostini', icon: 'ğŸ', cost: 1450, mps: 150 }, { name: 'Bananita Dolphinita', icon: 'ğŸ¬', cost: 1600, mps: 165 },
                { name: 'Perochello Lemonchello', icon: 'ğŸ‹', cost: 1750, mps: 182 }, { name: 'Brri Brri Bicus Dicus Bombicus', icon: 'ğŸ’£', cost: 1900, mps: 200 }, 
                { name: 'Avocadini Guffo', icon: 'ğŸ¦‰', cost: 2100, mps: 225 }, { name: 'Salamino Penguino', icon: 'ğŸ§', cost: 2300, mps: 245 },
                { name: 'Sammyni Spyderini', icon: 'ğŸ•·ï¸', cost: 2500, mps: 260 }, { name: 'Ti Ti Ti Sahur', icon: 'ğŸ•°ï¸', cost: 2600, mps: 270 },
                { name: 'Penguino Cocosino', icon: 'ğŸ¥¥', cost: 2700, mps: 280 }, { name: 'Cocosini Mama', icon: 'ğŸ‘©â€ğŸ‘§', cost: 2800, mps: 290 },
                { name: 'Frogato Pirato', icon: 'ğŸ¸', cost: 3000, mps: 310 }, { name: 'Mummio Rappitto', icon: 'ğŸ§Ÿ', cost: 3200, mps: 330 },
                { name: 'Karkerkar Kurkur', icon: 'ğŸš—', cost: 3500, mps: 340 }
            ],
            'Legendary': [
                { name: 'Burbaloni Loliloli', icon: 'ğŸ­', cost: 5000, mps: 500 }, { name: 'Chimpanzini Bananini', icon: 'ğŸ’', cost: 5500, mps: 555 }, 
                { name: 'Ballerina Cappuccina', icon: 'ğŸ‘¯', cost: 6000, mps: 610 }, { name: 'Chef Crabracadabra', icon: 'ğŸ¦€', cost: 6600, mps: 670 }, 
                { name: 'Lionel Cactuseli', icon: 'ğŸŒµ', cost: 7200, mps: 730 }, { name: 'Glorbo Fruttodrillo', icon: 'ğŸŠ', cost: 7900, mps: 800 },
                { name: 'Quivioli Ameleonni', icon: 'ğŸ¥', cost: 8600, mps: 875 }, { name: 'Blueberrinni Octopusini', icon: 'ğŸ™', cost: 9400, mps: 950 }, 
                { name: 'Pipi Potato', icon: 'ğŸ¥”', cost: 10200, mps: 1050 }, { name: 'Strawberrelli Flamingelli', icon: 'ğŸ“', cost: 11000, mps: 1150 }, 
                { name: 'Pandaccini Bananini', icon: 'ğŸ¼', cost: 12000, mps: 1250 }, { name: 'Sigma Boy', icon: 'ğŸ—¿', cost: 13000, mps: 1400 },
                { name: 'dul dul dul', icon: 'ğŸ”', cost: 15000, mps: 1500 }, { name: 'Quackula', icon: 'ğŸ¦†', cost: 16000, mps: 1600 }, { name: 'Buho De Fuego', icon: 'ğŸ”¥', cost: 17000, mps: 1700 }
            ],
            'Mythic': [
                { name: 'Frigo Camelo', icon: 'ğŸ«', cost: 25000, mps: 2100 }, { name: 'Orangutini Ananassini', icon: 'ğŸ', cost: 27000, mps: 2300 }, 
                { name: 'Rhino Toasterino', icon: 'ğŸ¦', cost: 30000, mps: 2600 }, { name: 'Bombardiro Crocodilo', icon: 'ğŸ’£', cost: 33000, mps: 2900 }, 
                { name: 'Spioniro Golubiro', icon: 'ğŸ•Šï¸', cost: 36000, mps: 3250 }, { name: 'Bombombini Gusini', icon: 'ğŸ›', cost: 40000, mps: 3600 },
                { name: 'Cavallo Virtuoso', icon: 'ğŸ´', cost: 44000, mps: 4000 }, { name: 'Gorillo Watermelondrillo', icon: 'ğŸ‰', cost: 48000, mps: 4400 }, 
                { name: 'Lerulerulerule', icon: 'ğŸ‘…', cost: 52000, mps: 4800 }, { name: 'Te Te Te Sahur', icon: 'ğŸ¥', cost: 57000, mps: 5300 }, 
                { name: 'Tracoducotulu Delapeladustuz', icon: 'ğŸ‰', cost: 62000, mps: 5900 }, { name: 'Toiletto Focaccino', icon: 'ğŸš½', cost: 68000, mps: 6600 },
                { name: 'Pi Pi Watermelon', icon: 'ğŸ‰', cost: 70000, mps: 6800 }, { name: 'Avocadorilla', icon: 'ğŸ¦', cost: 72000, mps: 7000 },
                { name: 'Tob Tobi Tobi', icon: 'ğŸ¶', cost: 75000, mps: 7200 }, { name: 'Ganganzelli Trulala', icon: 'ğŸ¶', cost: 78000, mps: 7500 },
                { name: 'Magi Ribbitini', icon: 'ğŸª„', cost: 80000, mps: 7800 }, { name: 'Jacko Spaventosa', icon: 'ğŸƒ', cost: 82000, mps: 8000 }
            ],
            'Brainrot God': [
                { name: 'Cocofanto Elefanto', icon: 'ğŸ˜', cost: 1.5e6, mps: 20000 }, { name: 'Girafa Celestre', icon: 'ğŸ¦’', cost: 1.8e6, mps: 35000 }, 
                { name: 'Tralalero Tralala', icon: 'ğŸ¶', cost: 2.2e6, mps: 50000 }, { name: 'Odin Din Din Dun', icon: 'âš¡', cost: 2.7e6, mps: 75000 }, 
                { name: 'Tralalita Tralala', icon: 'ğŸ¤', cost: 3.3e6, mps: 100000 }, { name: 'Trenostruzzo Turbo 3000', icon: 'ğŸš‚', cost: 4e6, mps: 150000 },
                { name: 'Trippi Troppi Troppa Trippa', icon: 'ğŸ˜µ', cost: 4.8e6, mps: 200000 }, { name: 'Ballerino Lololo', icon: 'ğŸ•º', cost: 5.5e6, mps: 275000 }, 
                { name: 'Pakrahmatmamat', icon: 'ğŸ“¦', cost: 6.2e6, mps: 350000 }, { name: 'Piccione Macchina', icon: 'ğŸ•Šï¸', cost: 7e6, mps: 450000 }, 
                { name: 'Tractoro Dinosauro', icon: 'ğŸ¦–', cost: 8e6, mps: 550000 }, { name: 'Los Orcalitos', icon: 'ğŸ‹', cost: 9e6, mps: 625000 }, 
                { name: 'Cacasito Satalito', icon: 'ğŸ›°ï¸', cost: 10e6, mps: 675000 }, { name: 'Tartaruga Cisterna', icon: 'ğŸ¢', cost: 12e6, mps: 700000 }
            ],
            'Secret': [
                { name: 'Bisonte Giuppitere', icon: 'ğŸƒ', cost: 1e9, mps: 1e6 }, { name: 'La Vacca Saturno Saturnita', icon: 'ğŸ„', cost: 1.5e9, mps: 2.5e6 }, 
                { name: 'Los Tralaleritos', icon: 'ğŸ‘¨â€ğŸ¤', cost: 2e9, mps: 5e6 }, { name: 'Las Tralaleritas', icon: 'ğŸ‘©â€ğŸ¤', cost: 2.8e9, mps: 10e6 }, 
                { name: 'Job Job Job Sahur', icon: 'ğŸ’¼', cost: 3.5e9, mps: 18e6 }, { name: 'Graipuss Medussi', icon: 'ğŸ‡', cost: 4.5e9, mps: 25e6 },
                { name: 'Chicleteira Bicicleteira', icon: 'ğŸš²', cost: 6e9, mps: 35e6 }, { name: 'Garama and Madundung', icon: 'ğŸ¤·', cost: 8e9, mps: 50e6 },
                { name: 'To To Sahur', icon: 'ğŸ¥', cost: 9e9, mps: 52e6 }, { name: 'Nuclearo Dinossauro', icon: 'â˜¢ï¸', cost: 10e9, mps: 55e6 },
                { name: 'Money Money Puggy', icon: 'ğŸ¤‘', cost: 11e9, mps: 58e6 }, { name: 'Ketupat Kepat', icon: ' K ', cost: 12e9, mps: 60e6 },
                { name: 'Tictac Sahur', icon: 'â°', cost: 13e9, mps: 62e6 }, { name: 'Ketchuru and Musturu', icon: 'ğŸŒ­', cost: 14e9, mps: 65e6 },
                { name: 'Burguro And Fryuro', icon: 'ğŸ”', cost: 15e9, mps: 68e6 }, { name: 'Dragon Cannelloni', icon: 'ğŸ‰', cost: 16e9, mps: 70e6 }
            ],
            'OG': [
                { name: 'Strawberry Elephant', icon: 'ğŸ“ğŸ˜', cost: 1e18, mps: 1e15, event: 'Strawberry' }, { name: 'Meowl', icon: 'ğŸ±', cost: 2e18, mps: 2e15, event: 'Meowl' },
                { name: 'Tung Tung Sahur', icon: 'ğŸ¶ğŸ¥', cost: 5e18, mps: 5e15, event: 'Tung Tung Attack' }, { name: 'Fluff', icon: 'â˜ï¸', cost: 1e21, mps: 1e18 }
            ]
        };
        
        const luckyBlockExclusives = {
            'Zibra Zubra Zibralini': { icon: 'ğŸ¦“', rarity: 'Mythic', cost: 40e3, mps: 3700 }, 'Tigrilini Watermelini': { icon: 'ğŸ…', rarity: 'Mythic', cost: 45e3, mps: 4100 },
            'Carrotini Brainini':    { icon: 'ğŸ¥•', rarity: 'Mythic', cost: 50e3, mps: 4500 }, 'Bananito Bandito':      { icon: 'ğŸŒ', rarity: 'Mythic', cost: 55e3, mps: 5000 },
            'Tigroligre Frutonni':   { icon: 'ğŸ¯', rarity: 'Brainrot God', cost: 7e6, mps: 480000 }, 'Orcalero Orcala':        { icon: 'ğŸ³', rarity: 'Brainrot God', cost: 8e6, mps: 560000 },
            'Bulbito Bandito Traktorito': { icon: 'ğŸ’¡', rarity: 'Brainrot God', cost: 9e6, mps: 630000 }, 'Mastodontico Telepiedone': { icon: 'ğŸ¦£', rarity: 'Brainrot God', cost: 10e6, mps: 680000 },
            'Pop Pop Sahur':         { icon: 'ğŸ¿', rarity: 'Brainrot God', cost: 11e6, mps: 690000 }, 'Torrtuginni Dragonfrutini': { icon: 'ğŸ¢', rarity: 'Secret', cost: 2e9, mps: 4e6 },
            'Pot Hotspot':           { icon: 'ëƒ„', rarity: 'Secret', cost: 3e9, mps: 8e6 }, 'Esok Sekolah':          { icon: 'ğŸ«', rarity: 'Secret', cost: 4e9, mps: 15e6 },
            'Spaghetti Tualetti':    { icon: 'ğŸ', rarity: 'Secret', cost: 5e9, mps: 20e6 }, 'La Secret Combinasion': { icon: 'ğŸ¤«', rarity: 'Secret', cost: 10e9, mps: 60e6 },
            'Chihuanini Taconini':   { icon: 'ğŸŒ®', rarity: 'Brainrot God', cost: 15e6, mps: 800000 }, 'Gattito Tacoto':        { icon: 'ğŸˆ', rarity: 'Brainrot God', cost: 18e6, mps: 900000 },
            'Los Tipi Tacos':        { icon: 'ğŸ’ƒ', rarity: 'Brainrot God', cost: 20e6, mps: 1e6 }, 'Quesadilla Crocodila':  { icon: 'ğŸŠ', rarity: 'Secret', cost: 12e9, mps: 70e6 },
            'Los Nooo My Hotspotsitos': { icon: 'ğŸ”¥', rarity: 'Secret', cost: 15e9, mps: 80e6 }, 'Burrito Bandito': { icon: 'ğŸŒ¯', rarity: 'Rare', cost: 600, mps: 60 },
            'Carloo':                { icon: 'ğŸ‘¨â€ğŸ¨', rarity: 'Mythic', cost: 100e3, mps: 8000 }, 'Los Bombinitos':        { icon: 'ğŸ’£', rarity: 'Brainrot God', cost: 25e6, mps: 1.2e6 }, 
            'Alessio':               { icon: 'ğŸ‘¨â€ğŸ’»', rarity: 'Brainrot God', cost: 30e6, mps: 1.5e6 }, 'Crabbo Limonetta':       { icon: 'ğŸ¦€', rarity: 'Brainrot God', cost: 35e6, mps: 1.8e6 }, 
            'Blackhole Goat':        { icon: 'ğŸ', rarity: 'Secret', cost: 20e9, mps: 100e6 }, 'Guerriro Digitale':      { icon: 'ğŸ‘¾', rarity: 'Secret', cost: 25e9, mps: 120e6 }, 
            '67':                    { icon: '6ï¸âƒ£7ï¸âƒ£', rarity: 'Secret', cost: 50e9, mps: 200e6 }, 'La Grande Combinasion': { icon: 'ğŸ¤¯', rarity: 'Secret', cost: 100e9, mps: 500e6 }, 
            'Los Tungtungtungcitos': { icon: 'ğŸ¶', rarity: 'Brainrot God', cost: 40e6, mps: 2e6 }, 'Los Tortus':             { icon: 'ğŸ¢', rarity: 'Secret', cost: 30e9, mps: 140e6 }, 
            'Los Jobcitos':          { icon: 'ğŸ’¼', rarity: 'Secret', cost: 35e9, mps: 160e6 }, 'Los Combinasionas':      { icon: 'ğŸ¤”', rarity: 'Secret', cost: 60e9, mps: 250e6 }, 
            'Los 67':                { icon: 'ğŸ‡²ğŸ‡½', rarity: 'Secret', cost: 70e9, mps: 300e6 }, 'Baby Jayce': { icon: 'ğŸ‘¶', rarity: 'Secret', cost: 1e20, mps: 1e17 },
            'Taco Baby Jayce': { icon: 'ğŸ‘¶ğŸŒ®', rarity: 'Secret', cost: 1e20, mps: 1e17 }, 'Ghost Baby Jayce': { icon: 'ğŸ‘»ğŸ‘¶', rarity: 'Secret', cost: 1e20, mps: 1e17 },
            'Vampira Cappucina': { icon: 'ğŸ§›', rarity: 'Mythic', cost: 90e3, mps: 8500 }, 'Zombie Tralala': { icon: 'ğŸ§Ÿ', rarity: 'Mythic', cost: 95e3, mps: 9000 },
            'Frankentteo': { icon: 'ğŸ§Ÿâ€â™‚ï¸', rarity: 'Brainrot God', cost: 50e6, mps: 2.5e6 }, 'La Vacca Jacko Linterino': { icon: 'ğŸƒğŸ„', rarity: 'Secret', cost: 50e9, mps: 210e6 },
            'La Spooky Grande': { icon: 'ğŸ‘»ğŸ¤¯', rarity: 'Secret', cost: 80e9, mps: 400e6 }, 'Mummy Ambalabu': { icon: 'ğŸ§ŸğŸ’ƒ', rarity: 'Brainrot God', cost: 45e6, mps: 2.2e6 },
            'Cappuccino Clownino': { icon: 'ğŸ¤¡â˜•', rarity: 'Brainrot God', cost: 48e6, mps: 2.4e6 }, 'Jackorilla': { icon: 'ğŸ¦ğŸƒ', rarity: 'Secret', cost: 55e9, mps: 230e6 },
            'Pumpkini Spyderini': { icon: 'ğŸƒğŸ•·ï¸', rarity: 'Secret', cost: 60e9, mps: 250e6 }, 'Trickolino': { icon: 'ğŸ¬', rarity: 'Secret', cost: 65e9, mps: 280e6 },
            'Telemorte': { icon: 'ğŸ“ºğŸ’€', rarity: 'Secret', cost: 70e9, mps: 300e6 }, 'Los Spooky Combinasionas': { icon: 'ğŸ‘»ğŸ¤”', rarity: 'Secret', cost: 75e9, mps: 350e6 },
            'La Casa Boo': { icon: 'ğŸšï¸ğŸ‘»', rarity: 'Secret', cost: 90e9, mps: 450e6 }
        };
        const luckyBlockManifest = {
            'Mythic Lucky Block': { icon: 'â“', color: rarities['Mythic'].color, weight: 50, lootTable: [{ name: 'Spioniro Golubiro', chance: 37 }, { name: 'Zibra Zubra Zibralini', chance: 30 }, { name: 'Tigrilini Watermelini', chance: 20 }, { name: 'Carrotini Brainini', chance: 10 }, { name: 'Bananito Bandito', chance: 3 }] },
            'Brainrot God Lucky Block': { icon: 'âœ¨', color: rarities['Brainrot God'].color, weight: 25, lootTable: [{ name: 'Tigroligre Frutonni', chance: 54 }, { name: 'Orcalero Orcala', chance: 30 }, { name: 'Bulbito Bandito Traktorito', chance: 10 }, { name: 'Mastodontico Telepiedone', chance: 5 }, { name: 'Pop Pop Sahur', chance: 1 }] },
            'Secret Lucky Block': { icon: 'ğŸ¤«', color: rarities['Secret'].color, weight: 10, lootTable: [{ name: 'Torrtuginni Dragonfrutini', chance: 74.5 }, { name: 'Pot Hotspot', chance: 21 }, { name: 'Esok Sekolah', chance: 3 }, { name: 'Spaghetti Tualetti', chance: 1 }, { name: 'La Secret Combinasion', chance: 0.5 }] },
            'Taco Lucky Block': { icon: 'ğŸŒ®', color: '#ffb347', weight: 5, lootTable: [{ name: 'Chihuanini Taconini', chance: 45 }, { name: 'Gattito Tacoto', chance: 29.5 }, { name: 'Los Tipi Tacos', chance: 10 }, { name: 'Quesadilla Crocodila', chance: 5 }, { name: 'Los Nooo My Hotspotsitos', chance: 3 }, { name: 'Burrito Bandito', chance: 7 }, { name: 'Taco Baby Jayce', chance: 0.5 }] },
            'Admin Lucky Block': { icon: 'ğŸ¤–', color: '#b042f5', weight: 1, lootTable: [{ name: 'Carloo', chance: 29.9 }, { name: 'Los Bombinitos', chance: 30 }, { name: 'Alessio', chance: 20 }, { name: 'Crabbo Limonetta', chance: 10 }, { name: 'Blackhole Goat', chance: 5 }, { name: 'Guerriro Digitale', chance: 3 }, { name: '67', chance: 1 }, { name: 'La Grande Combinasion', chance: 1 }, { name: 'Baby Jayce', chance: 0.1 }] },
            'Los Lucky Block': { icon: 'ğŸ‡²ğŸ‡½', color: '#006847', weight: 2, lootTable: [{ name: 'Los Bombinitos', chance: 40 }, { name: 'Los Tungtungtungcitos', chance: 25 }, { name: 'Los Orcalitos', chance: 15 }, { name: 'Los Tipi Tacos', chance: 10 }, { name: 'Los Tortus', chance: 5 }, { name: 'Los Jobcitos', chance: 3.5 }, { name: 'Los Combinasionas', chance: 1 }, { name: 'Los 67', chance: 0.5 }] },
            'Secret Halloween Lucky Block': { icon: 'ğŸƒ', color: '#f97316', weight: 2, lootTable: [{ name: 'Vampira Cappucina', chance: 80 }, { name: 'Zombie Tralala', chance: 50 }, { name: 'Frankentteo', chance: 20 }, { name: 'La Vacca Jacko Linterino', chance: 5 }, { name: 'La Spooky Grande', chance: 1 }] },
            'Spooky Lucky Block': { icon: 'ğŸ‘»', color: '#a855f7', weight: 2, lootTable: [{ name: 'Mummy Ambalabu', chance: 32.7 }, { name: 'Cappuccino Clownino', chance: 32.5 }, { name: 'Jackorilla', chance: 19.5 }, { name: 'Pumpkini Spyderini', chance: 9 }, { name: 'Trickolino', chance: 3 }, { name: 'Telemorte', chance: 2 }, { name: 'Los Spooky Combinasionas', chance: 1 }, { name: 'La Casa Boo', chance: 0.3 }, { name: 'Ghost Baby Jayce', chance: 0.1 }] }
        };
        
        const ritualExclusives = {
            'Los Matteos': { icon: 'ğŸ‘¨â€ğŸ‘¨â€ğŸ‘¦', cost: 20e9, mps: 110e6, rarity: 'Secret' }, 'Los Spyderinis': { icon: 'ğŸ•¸ï¸', cost: 22e9, mps: 115e6, rarity: 'Secret' },
            'Las Vaquitas Saturnitas': { icon: 'ğŸ„ğŸ„', cost: 25e9, mps: 125e6, rarity: 'Secret' }, 'Los Chicleteiras': { icon: 'ğŸš²ğŸš²', cost: 30e9, mps: 150e6, rarity: 'Secret' },
            'Yes my examine': { icon: 'ğŸ‘', cost: 40e9, mps: 180e6, rarity: 'Secret' }, 'No my examine': { icon: 'ğŸ‘', cost: 50e9, mps: 220e6, rarity: 'Secret' },
            'Los Cocodillitos': { icon: 'ğŸŠğŸŠ', cost: 18e9, mps: 90e6, rarity: 'Secret' }, 'Los Orcalitos (Ritual)': { name: 'Los Orcalitos', icon: 'ğŸ‹ğŸ‹', cost: 30e9, mps: 150e6, rarity: 'Secret' },
            '1x1x1x1': { icon: '1ï¸âƒ£', cost: 100e9, mps: 500e6, rarity: 'Secret' }, 'Guest 666': { icon: 'Guest', cost: 200e9, mps: 1e9, rarity: 'Secret' }
        };
        const ritualRecipes = {
            'Los Matteos': { ingredients: { 'Matteo': 3 } }, 'Los Spyderinis': { ingredients: { 'Sammyni Spyderini': 4 } },
            'Las Vaquitas Saturnitas': { ingredients: { 'La Vacca Saturno Saturnita': 4 } }, 'Los Chicleteiras': { ingredients: { 'Chicleteira Bicicleteira': 2 } },
            'Yes my examine': { ingredients: { 'dul dul dul': 4 } }, 'No my examine': { ingredients: { 'dul dul dul': 6 } },
            'Los Cocodillitos': { ingredients: { 'Bombardiro Crocodilo': 4 } }, 'Los Orcalitos (Ritual)': { ingredients: { 'Orcalero Orcala': 3 } },
            '1x1x1x1': { ingredients: { 'Guerriro Digitale': 4 } }, 'Guest 666': { ingredients: { 'Guerriro Digitale': 10 } }
        };

        const craftExclusives = {
            'Las Cappuchinas': { icon: 'ğŸ‘¯â˜•', rarity: 'Brainrot God', cost: 8e6, mps: 400000 },
            'Belula Beluga': { icon: 'ğŸ³ğŸˆ', rarity: 'Brainrot God', cost: 9e6, mps: 450000 },
            'Fragola La La La': { icon: 'ğŸ“ğŸ¶', rarity: 'Secret', cost: 5e9, mps: 25e6 },
            'La Karkerkar Combinasion': { icon: 'ğŸš—ğŸ¤¯', rarity: 'Secret', cost: 7e9, mps: 35e6 },
            'La Sahur Combinasion': { icon: 'ğŸ¥ğŸ¤¯', rarity: 'Secret', cost: 15e9, mps: 70e6 },
            'Las Sis': { icon: 'ğŸ‘¯â€â™€ï¸', rarity: 'Secret', cost: 20e9, mps: 90e6 },
            'Celularcini Viciosini': { icon: 'ğŸ“±ğŸ˜µ', rarity: 'Secret', cost: 30e9, mps: 150e6 },
            'Los Bros': { icon: 'ğŸ˜ğŸ‘Š', rarity: 'Secret', cost: 50e9, mps: 250e6 },
            'Tralaledon': { icon: 'ğŸ¶ğŸ¦–', rarity: 'Secret', cost: 40e9, mps: 200e6 },
            'Los Tacoritas': { icon: 'ğŸŒ®ğŸš²', rarity: 'Secret', cost: 25e9, mps: 120e6 },
            'Los Primos': { icon: 'ğŸ‘¨â€ğŸ‘¦â€ğŸ‘¦', rarity: 'Secret', cost: 100e9, mps: 500e6 }
        };

        const craftRecipes = {
            'Las Cappuchinas': { ingredients: { 'Ballerina Cappuccina': 2, 'Tralalita Tralala': 2 } },
            'Belula Beluga': { ingredients: { 'Tralalita Tralala': 2, 'Matteo': 1, 'Alessio': 1 } },
            'Fragola La La La': { ingredients: { 'Odin Din Din Dun': 3, 'Sammyni Spyderini': 1 } },
            'La Karkerkar Combinasion': { ingredients: { 'Karkerkar Kurkur': 2 } },
            'La Sahur Combinasion': { ingredients: { 'Ta Ta Ta Ta Sahur': 1, 'Te Te Te Sahur': 1, 'Graipuss Medussi': 1, 'Job Job Job Sahur': 1 } },
            'Las Sis': { ingredients: { 'Las Cappuchinas': 1, 'Las Tralaleritas': 2 } },
            'Celularcini Viciosini': { ingredients: { 'Pot Hotspot': 1, 'Job Job Job Sahur': 1, 'La Grande Combinasion': 2 } },
            'Los Bros': { ingredients: { 'Los Tungtungtungcitos': 1, 'Los Combinasionas': 1, 'La Grande Combinasion': 1, 'Los Tralaleritos': 1 } },
            'Tralaledon': { ingredients: { 'Tralalero Tralala': 3, 'Nuclearo Dinossauro': 1 } },
            'Los Tacoritas': { ingredients: { 'Tacorita Bicicleta': 2 } },
            'Los Primos': { ingredients: { 'Los Orcalitos': 1, '67': 1, 'Los Bros': 1, 'Los Tralaleritos': 1 } }
        };

        const fuseExclusives = {
            // Taco Fuse
            'Tipi Topi Taco': { icon: 'ğŸŒ®', rarity: 'Brainrot God', cost: 60e6, mps: 2.5e6 }, 'Capi Taco': { icon: 'ğŸ§¢', rarity: 'Brainrot God', cost: 70e6, mps: 3e6 },
            'Bombardini Tortini': { icon: 'ğŸ’£', rarity: 'Brainrot God', cost: 80e6, mps: 3.5e6 }, 'Nooo My Hotspot': { icon: 'ğŸ”¥', rarity: 'Secret', cost: 1e12, mps: 500e6 },
            'Tacorita Bicicleta': { icon: 'ğŸš²', rarity: 'Secret', cost: 1.5e12, mps: 700e6 }, 'Perrito Burrito': { icon: 'ğŸ¶', rarity: 'Secret', cost: 2e12, mps: 900e6 },
            'Chillin Chili': { icon: 'ğŸŒ¶ï¸', rarity: 'Secret', cost: 2.5e12, mps: 1.1e9 }, 'Quesadillo Vampiro': { icon: 'ğŸ§›', rarity: 'Secret', cost: 3e12, mps: 1.3e9 },
            'Chipso and Queso': { icon: 'ğŸ§€', rarity: 'Secret', cost: 3.5e12, mps: 1.5e9 }, 'La Taco Combinasion': { icon: 'ğŸ¤¯', rarity: 'Secret', cost: 5e12, mps: 2e9 },
            // Normal Fuse
            'Tukanno Bananno': { icon: 'ğŸŒ', rarity: 'Brainrot God', cost: 50e6, mps: 2.5e6 }, 'Brr es Teh Patipum': { icon: 'ğŸ§Š', rarity: 'Brainrot God', cost: 55e6, mps: 2.8e6 },
            'Agarrini La Palini': { icon: 'âœ‹', rarity: 'Secret', cost: 1.2e12, mps: 600e6 }, 'Los Hotspotsitos': { icon: 'ğŸ”¥', rarity: 'Secret', cost: 2.2e12, mps: 1e9 },
            'La Supreme Combinasion': { icon: 'ğŸ‘‘', rarity: 'Secret', cost: 10e12, mps: 5e9 },
            // Witch Fuse
            'Jacko Jack Jack': { icon: 'ğŸƒ', rarity: 'Brainrot God', cost: 50e6, mps: 2.5e6 }, 'Tentacolo Tecnico': { icon: 'ğŸ™', rarity: 'Brainrot God', cost: 55e6, mps: 2.8e6 },
            'Snailenzo': { icon: 'ğŸŒ', rarity: 'Brainrot God', cost: 60e6, mps: 3e6 }, 'Vulturino Skeletono': { icon: 'ğŸ’€', rarity: 'Secret', cost: 1.5e12, mps: 700e6 },
            'Los Mobilis': { icon: 'ğŸ“±', rarity: 'Secret', cost: 2e12, mps: 900e6 }, 'Mieteteira Bicicleteira': { icon: 'ğŸš²', rarity: 'Secret', cost: 2.5e12, mps: 1.1e9 },
            'Eviledon': { icon: 'ğŸ˜ˆ', rarity: 'Secret', cost: 3e12, mps: 1.3e9 }, 'Spooky and Pumpky': { icon: 'ğŸ‘»', rarity: 'Secret', cost: 3.5e12, mps: 1.5e9 },
            'Headless Horseman': { icon: 'ğŸ´', rarity: 'Secret', cost: 5e12, mps: 2e9 }
        };
        const fuseRecipes = {
            'Taco': [
                { inputRarity: 'Brainrot God', count: 4, output: ['Tipi Topi Taco', 'Capi Taco', 'Bombardini Tortini'] },
                { inputRarity: 'Secret', count: 4, output: ['Nooo My Hotspot', 'Tacorita Bicicleta', 'Perrito Burrito', 'Chillin Chili', 'Quesadillo Vampiro', 'Chipso and Queso', 'La Taco Combinasion'] }
            ],
            'Normal': [
                { inputRarity: 'Mythic', count: 4, output: ['Tukanno Bananno', 'Brr es Teh Patipum', 'Los Tungtungtungcitos'] },
                { inputRarity: 'Brainrot God', count: 4, output: ['Agarrini La Palini', 'Los Combinasionas', 'Los Hotspotsitos'] },
                { inputRarity: 'Secret', count: 4, output: ['La Supreme Combinasion'] }
            ],
            'Witch': [
                { inputRarity: 'Mythic', count: 4, output: ['Jacko Jack Jack', 'Tentacolo Tecnico', 'Snailenzo'] },
                { inputRarity: 'Brainrot God', count: 4, output: ['Vulturino Skeletono', 'Los Mobilis', 'Mieteteira Bicicleteira', 'Eviledon', 'Spooky and Pumpky', 'Headless Horseman'] }
            ]
        };

        const dealerExclusives = {
            'Cupcake Koala': { icon: 'ğŸ¨', rarity: 'Rare', cost: 800, mps: 70, initialStock: 10 },
            'Doi Doi Do': { icon: 'ğŸ¦œ', rarity: 'Epic', cost: 4000, mps: 400, initialStock: 8 },
            'Clickerino Crabo': { icon: 'ğŸ¦€', rarity: 'Legendary', cost: 20000, mps: 2200, initialStock: 5 },
            'Stoppo Luminio': { icon: 'ğŸ›‘', rarity: 'Mythic', cost: 150000, mps: 18000, initialStock: 3 },
            'Money Money Man': { icon: 'ğŸ¤‘', rarity: 'Brainrot God', cost: 10e6, mps: 900000, initialStock: 2 },
            'Noo la Polizia': { icon: 'ğŸ‘®', rarity: 'Brainrot God', cost: 12e6, mps: 1.1e6, initialStock: 2 },
            'Pirulitoita Bicicleteria': { icon: 'ğŸ­ğŸš²', rarity: 'Secret', cost: 50e9, mps: 300e6, initialStock: 1 },
            'Los Puggies': { icon: 'ğŸ¶ğŸ¶', rarity: 'Secret', cost: 75e9, mps: 500e6, initialStock: 1 },
            'Los Spaghetties': { icon: 'ğŸğŸ', rarity: 'Secret', cost: 100e9, mps: 750e6, initialStock: 1 },
            'Fragrama and Chocrama': { icon: 'ğŸ“ğŸ«', rarity: 'Secret', cost: 500e9, mps: 4e9, initialStock: 1 }
        };

        const rebirthRequirements = [
            /* 1 */ { cost: 1e6, units: ['Pipi Kiwi', 'Trippi Troppi'] }, /* 2 */ { cost: 3e6, units: ['Brr Brr Patapim', 'Boneca Ambalabu'] },
            /* 3 */ { cost: 12.5e6, units: ['Trulimero Trulicina', 'Chimpanzini Bananini'] }, /* 4 */ { cost: 35e6, units: ['Chef Crabracadabra', 'Glorbo Fruttodrillo'] },
            /* 5 */ { cost: 100e6, units: ['Frigo Camelo', 'Orangutini Ananassini'] }, /* 6 */ { cost: 350e6, units: ['Bombardiro Crocodilo'] },
            /* 7 */ { cost: 1e9, units: ['Bombombini Gusini'] }, /* 8 */ { cost: 5e9, units: ['Te Te Te Sahur'] },
            /* 9 */ { cost: 25e9, units: ['Cocofanto Elefanto'] }, /* 10 */ { cost: 250e9, units: ['Girafa Celestre'] },
            /* 11 */ { cost: 1e12, units: ['Tralalero Tralala'] }, /* 12 */ { cost: 35e12, units: ['Trenostruzzo Turbo 3000'] },
            /* 13 */ { cost: 100e12, units: ['Trippi Troppi Troppa Trippa'] }, /* 14 */ { cost: 500e12, units: ['Pakrahmatmamat'] },
            /* 15 */ { cost: 1e15, units: ['Los Tralaleritos'] },
        ];
        
        // This is now defined globally
        const allBrainrotData = [];
        for (const rarityName in brainrotManifest) { brainrotManifest[rarityName].forEach(b => { allBrainrotData.push({ ...b, rarity: rarityName }); }); }
        for (const brainrotName in luckyBlockExclusives) { allBrainrotData.push({ name: brainrotName, ...luckyBlockExclusives[brainrotName] }); }
        for (const brainrotName in ritualExclusives) { const data = ritualExclusives[brainrotName]; allBrainrotData.push({ name: data.name || brainrotName, ...data }); }
        for (const brainrotName in craftExclusives) { const data = craftExclusives[brainrotName]; allBrainrotData.push({ name: data.name || brainrotName, ...data }); }
        for (const brainrotName in fuseExclusives) { const data = fuseExclusives[brainrotName]; allBrainrotData.push({ name: data.name || brainrotName, ...data }); }
        for (const brainrotName in dealerExclusives) { allBrainrotData.push({ name: brainrotName, ...dealerExclusives[brainrotName] }); }

        const totalLuckyBlockWeight = Object.values(luckyBlockManifest).reduce((s, b) => s + b.weight, 0);
        const allBrainrotNames = new Set(allBrainrotData.map(b => b.name));
        const totalBrainrotsCount = allBrainrotNames.size;

        
        // --- Firebase Globals ---
        let app, auth, db;
        let userId;
        let eventsCollectionPath, userSaveDocPath;
        let globalEventListener = null;
        let isAdmin = false;

        // --- Game State ---
        let money = 100, baseSlots = [], beltItems = [], discoveredBrainrots = new Set(), rebirths = 0, luck = 0;
        let timeUntilLegendary = 60, timeUntilMythic = 300, timeUntilBrainrotGod = 1800;
        let gameInterval, timerInterval, isPaused = false, isSellMode = false;
        let maxBaseSlots = 10, moneyMultiplier = 1;
        let activeEvents = {}; // For weather/traits
        let tacoEventInterval = null;
        let currentDealerStock = {}; // State for local dealer stock
        
        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const HARDCODED_FIREBASE_CONFIG = {
           apiKey: "AIzaSyB_8Eao4PirrTF6DBjjbUmhL6MyXnt6vzY",
           authDomain: "steal-the-brainrot-admin-panel.firebaseapp.com",
           projectId: "steal-the-brainrot-admin-panel",
           storageBucket: "steal-the-brainrot-admin-panel.firebasestorage.app",
           messagingSenderId: "559691711111",
           appId: "1:559691711111:web:27dff3446aea0ef624ee22",
           measurementId: "G-3FPEYCR4JM"
        };

        async function initializeFirebase() {
            try {
                // Try to get config from environment, fallback to hardcoded
                let firebaseConfig = HARDCODED_FIREBASE_CONFIG;
                if (firebaseConfig.apiKey === "YOUR_API_KEY" && typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(atob(__firebase_config));
                }
                
                // FIX: Check if config is valid
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.warn("Firebase config is missing. Game will run in offline mode.");
                    loadingSpinner.classList.add('hidden');
                    gameRoot.classList.remove('hidden');
                    initGameLogic(); // Start game logic without auth
                    return; // Stop firebase init
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User signed in:", userId);
                        
                        // Define user-specific paths
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        userSaveDocPath = `/artifacts/${appId}/users/${userId}/saveData/gameSave`;
                        eventsCollectionPath = `/artifacts/${appId}/public/data/events`;
                        
                        await loadGame(); // Load data from Firebase
                        initGameLogic(); // Start game loops
                        setupGlobalEventListener(); // Start listening for admin events
                        
                        loadingSpinner.classList.add('hidden');
                        gameRoot.classList.remove('hidden');

                    } else {
                        console.log("No user found, signing in...");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (e) {
                                console.warn("Custom token auth failed, falling back to anonymous:", e);
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                // Fallback to offline mode if init fails
                loadingSpinner.classList.add('hidden');
                gameRoot.classList.remove('hidden');
                initGameLogic();
            }
        }

        function initGameLogic() {
            updateDerivedState();
            initBase();
            
            // Init dealer stock if not loaded
            if (Object.keys(currentDealerStock).length === 0) {
                for (const name in dealerExclusives) {
                    currentDealerStock[name] = dealerExclusives[name].initialStock;
                }
            }
            
            populateAdminDropdowns();
            gameInterval = setInterval(gameLoop, 1000 / 60);
            timerInterval = setInterval(updateTimers, 1000);
            setTimeout(spawnBrainrotOnBelt, 1000);
            checkTacoTuesday();
            updateAllUI();
        }

        function setupGlobalEventListener() {
            if (globalEventListener || !db) return; // Don't run if no DB or already listening

            const loadTime = new Date();
            const q = query(collection(db, eventsCollectionPath), where("timestamp", ">", loadTime));

            globalEventListener = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const event = change.doc.data();
                        console.log("Global Event Received:", event);
                        handleGlobalEvent(event);
                    }
                });
            }, (error) => {
                console.error("Error listening to global events:", error);
            });
        }

        function handleGlobalEvent(event) {
            switch(event.type) {
                case 'chat':
                    showNotification(`JAYCE: ${event.message}`, 'white');
                    break;
                case 'spawn':
                    spawnBrainrotByName(event.name, event.mutation, event.trait);
                    break;
                case 'spawn_lucky_block':
                    spawnLuckyBlockOnBelt(event.name);
                    break;
                case 'event':
                    startWeatherEvent(event.name);
                    break;
                case 'taco_event':
                    startTacoEvent();
                    break;
                case 'all_events':
                      for (const eventName in weatherEvents) { startWeatherEvent(eventName); }
                    break;
                case 'stop_all_events':
                    activeEvents = {};
                    // Clear traits from base
                    baseSlots.forEach(slot => {
                        if (slot) slot.trait = null;
                    });
                    renderBase();
                    updateAllUI();
                    updateActiveEventsUI();
                    showNotification("All events have been stopped.", "gray");
                    break;
                case 'restock_dealer':
                    if (event.item === 'All') {
                        for (const name in dealerExclusives) {
                            currentDealerStock[name] = dealerExclusives[name].initialStock;
                        }
                        showNotification("Dealer fully restocked!", "green");
                    } else if (dealerExclusives[event.item]) {
                        currentDealerStock[event.item] = dealerExclusives[event.item].initialStock;
                        showNotification(`${event.item} restocked!`, "green");
                    }
                    if (!dealerModal.classList.contains('hidden')) {
                        renderDealerModal();
                    }
                    break;
            }
        }

        async function sendGlobalEvent(type, payload) {
            if (!isAdmin) {
                showNotification("You are not an admin.", "red");
                return;
            }
            if (!db) {
                showNotification("Not connected to Firebase.", "red");
                return;
            }
            try {
                await addDoc(collection(db, eventsCollectionPath), {
                    ...payload,
                    type: type,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending global event:", error);
                showNotification("Failed to send command.", "red");
            }
        }

        function gameLoop() { if (!isPaused) { updateMoney(); updateBeltItems(); } }
        function updateTimers() { if (!isPaused) { timeUntilLegendary--; timeUntilMythic--; timeUntilBrainrotGod--; if (timeUntilLegendary <= 0) { spawnSpecificBrainrot('Legendary'); timeUntilLegendary = 60; } if (timeUntilMythic <= 0) { spawnSpecificBrainrot('Mythic'); timeUntilMythic = 300; } if (timeUntilBrainrotGod <= 0) { spawnSpecificBrainrot('Brainrot God'); timeUntilBrainrotGod = 1800; } updateTimerDisplay(); updateActiveEvents(); } }
        function updateDerivedState() { maxBaseSlots = 10 + rebirths; moneyMultiplier = 1; } // Multiplier is now trait-based
        
        function initBase() {
            baseContainer.innerHTML = '';
            baseSlots = Array(maxBaseSlots).fill(null);
            for (let i = 0; i < maxBaseSlots; i++) {
                const slot = document.createElement('div');
                slot.classList.add('base-slot');
                slot.dataset.index = i;
                slot.onclick = () => handleBaseSlotClick(i);
                baseContainer.appendChild(slot);
            }
        }

        function spawnBrainrotOnBelt() {
            if (isPaused) { setTimeout(spawnBrainrotOnBelt, Math.random() * 2500 + 1000); return; };
            const rarity = getRandomRarity();
            if (rarity === 'Lucky Block') {
                spawnLuckyBlockOnBelt();
            } else if (rarity) {
                spawnSpecificBrainrot(rarity);
            }
            setTimeout(spawnBrainrotOnBelt, Math.random() * 2500 + 1000);
        }

        function spawnLuckyBlockOnBelt(forceBlockType = null) {
            let blockType = forceBlockType;
            if (!blockType) {
                let random = Math.random() * totalLuckyBlockWeight;
                for (const name in luckyBlockManifest) {
                    if (random < luckyBlockManifest[name].weight) { blockType = name; break; }
                    random -= luckyBlockManifest[name].weight;
                }
            }
            if (!blockType) return;
            const blockData = luckyBlockManifest[blockType];
            const itemWrapper = document.createElement('div');
            itemWrapper.classList.add('belt-item-wrapper');
            itemWrapper.innerHTML = `<div class="belt-item-label">${blockType}</div><div class="belt-item" style="border-color: ${blockData.color}; --glow-color: ${blockData.color};">${blockData.icon}</div>`;
            const block = { id: Date.now() + Math.random(), element: itemWrapper, position: -150 };
            itemWrapper.onclick = () => openLuckyBlock(block, blockType);
            beltItems.push(block);
            conveyorBelt.appendChild(itemWrapper);
        }
        
        function openLuckyBlock(block, blockType) {
            const emptySlotIndex = baseSlots.findIndex(s => s === null);
            if (emptySlotIndex === -1) { showNotification("Your base is full!", "red"); return; }
            block.element.remove();
            beltItems = beltItems.filter(b => b.id !== block.id);
            const blockData = luckyBlockManifest[blockType];
            const lootTable = blockData.lootTable;
            const totalChance = lootTable.reduce((s, l) => s + l.chance, 0);
            let random = Math.random() * totalChance;
            let prizeName = '';
            for (const loot of lootTable) {
                if (random < loot.chance) { prizeName = loot.name; break; }
                random -= loot.chance;
            }
            let prizeData = findBrainrotData(prizeName);
            if (prizeData) {
                const brainrot = { ...prizeData, mutation: getRandomMutation(), trait: null };
                baseSlots[emptySlotIndex] = brainrot;
                discoveredBrainrots.add(prizeName);
                if (brainrot.event) startWeatherEvent(brainrot.event);
                showNotification(`You found a ${prizeName}!`, rarities[prizeData.rarity].color);
                renderBase();
                updateAllUI();
            }
        }

        function findBrainrotData(name) {
            if(name === 'Los Orcalitos (Ritual)') name = 'Los Orcalitos';
            if (dealerExclusives[name]) { return { name, ...dealerExclusives[name] }; }
            if (ritualExclusives[name]) { return { name, ...ritualExclusives[name] }; }
            if (craftExclusives[name]) { return { name, ...craftExclusives[name] }; }
            if (fuseExclusives[name]) { return { name, ...fuseExclusives[name] }; }
            if (luckyBlockExclusives[name]) { return { name, ...luckyBlockExclusives[name] }; }
            for (const rarity in brainrotManifest) { const found = brainrotManifest[rarity].find(b => b.name === name); if (found) return { ...found, rarity }; }
            return null;
        }

        function spawnSpecificBrainrot(rarityName) {
            const possibleBrainrots = brainrotManifest[rarityName];
            if (!possibleBrainrots || possibleBrainrots.length === 0) return;
            const brainrotData = possibleBrainrots[Math.floor(Math.random() * possibleBrainrots.length)];
            spawnBrainrotByName(brainrotData.name, getRandomMutation());
        }

        function spawnBrainrotByName(brainrotName, mutation = null, trait = null) {
            let brainrotData = findBrainrotData(brainrotName);
            if (!brainrotData) { console.error("Spawn Error: Brainrot not found:", brainrotName); return; }
            const rarityData = rarities[brainrotData.rarity];
            const itemWrapper = document.createElement('div');
            itemWrapper.classList.add('belt-item-wrapper');
            let mutationIcon = '';
            let finalMutation = mutation || getRandomMutation();
            if (finalMutation && finalMutation.name !== 'None') { mutationIcon = `<div class="mutation-icon" style="background: ${finalMutation.color};">${finalMutation.icon}</div>`; }
            
            itemWrapper.innerHTML = `
                <div class="belt-item-label">
                    <div>${finalMutation.name !== 'None' ? finalMutation.name : ''} ${brainrotData.name}</div>
                    <div style="color: ${rarityData.color}">${brainrotData.rarity}</div>
                    <div>Cost: <span class="font-bold text-green-400">$${formatLargeNumber(brainrotData.cost)}</span></div>
                    <div>MPS: <span class="font-bold text-yellow-400">${formatLargeNumber(brainrotData.mps * finalMutation.multiplier)}</span></div>
                </div>
                <div class="belt-item" style="border-color: ${rarityData.color}; --glow-color: ${rarityData.glow};">
                    ${brainrotData.icon}
                    ${mutationIcon}
                </div>`;
            const brainrot = { id: Date.now() + Math.random(), ...brainrotData, element: itemWrapper, position: -150, mutation: finalMutation, trait: trait || null };
            itemWrapper.onclick = () => buyBrainrot(brainrot);
            beltItems.push(brainrot);
            conveyorBelt.appendChild(itemWrapper);
        }

        function updateBeltItems() { const beltWidth = conveyorBelt.offsetWidth; const speed = 1.2; beltItems = beltItems.filter(item => { item.position += speed; item.element.style.transform = `translateX(${item.position}px) translateY(-50%)`; if (item.position > beltWidth + 50) { item.element.remove(); return false; } return true; }); }
        function buyBrainrot(brainrot) { 
            const emptySlotIndex = baseSlots.findIndex(slot => slot === null); 
            if (money < brainrot.cost || emptySlotIndex === -1) return; 
            money -= brainrot.cost; 
            
            // Check for trait application
            let appliedTrait = null;
            if(brainrot.trait) { // Pass trait from admin spawn
                appliedTrait = brainrot.trait;
            } else { // Check for active events
                for(const eventName in activeEvents) {
                    if(Math.random() < 0.25) { // 25% chance to get trait
                        appliedTrait = { ...weatherEvents[eventName] };
                        break; // Only apply one trait
                    }
                }
            }
            
            baseSlots[emptySlotIndex] = { ...brainrot, trait: appliedTrait }; 
            discoveredBrainrots.add(brainrot.name); 
            if (brainrot.event) startWeatherEvent(brainrot.event);
            brainrot.element.remove(); 
            beltItems = beltItems.filter(b => b.id !== brainrot.id); 
            renderBase(); 
            updateAllUI(); 
        }
        function handleBaseSlotClick(index) { if (isSellMode && baseSlots[index]) { const brainrotToSell = baseSlots[index]; const sellPrice = Math.floor(brainrotToSell.cost * SELL_MULTIPLIER); money += sellPrice; baseSlots[index] = null; renderBase(); updateAllUI(); } }
        
        function renderBase() { 
            const slots = baseContainer.children; 
            for (let i = 0; i < maxBaseSlots; i++) { 
                const slot = slots[i]; 
                if (!slot) continue; 
                const brainrot = baseSlots[i]; 
                if (brainrot) { 
                    const rarityData = rarities[brainrot.rarity]; 
                    let mutationIcon = '';
                    if (brainrot.mutation && brainrot.mutation.name !== 'None') { 
                        mutationIcon = `<div class="mutation-icon" style="background: ${brainrot.mutation.color};" title="${brainrot.mutation.name} (x${brainrot.mutation.multiplier} MPS)">${brainrot.mutation.icon}</div>`; 
                    }
                    let traitIcon = '';
                    if (brainrot.trait) { 
                        traitIcon = `<div class="trait-icon" style="color: ${brainrot.trait.color};" title="${brainrot.trait.name} (x${brainrot.trait.multiplier} MPS)">${brainrot.trait.icon}</div>`; 
                    }
                    slot.innerHTML = `<div class="base-item" style="border-color: ${rarityData.color}; background-color: #374151;">${brainrot.icon}${mutationIcon}${traitIcon}</div>`; 
                } else { 
                    slot.innerHTML = ''; 
                } 
            } 
        }
        
        function updateAllUI() { 
            moneyDisplay.textContent = formatLargeNumber(Math.floor(money)); 
            const count = baseSlots.filter(s => s !== null).length; 
            baseCountDisplay.textContent = `${count} / ${maxBaseSlots}`; 
            let totalMPS = 0;
            let baseRebirthMultiplier = 1 + rebirths * 0.02;
            baseSlots.forEach(b => {
                if (b) {
                    const mutationMultiplier = b.mutation?.multiplier || 1;
                    const traitMultiplier = b.trait?.multiplier || 1;
                    totalMPS += b.mps * mutationMultiplier * traitMultiplier;
                }
            });
            mpsDisplay.textContent = formatLargeNumber(totalMPS * baseRebirthMultiplier); 
            rebirthDisplay.textContent = rebirths.toLocaleString(); 
            updateIndexCounter(); 
        }
        
        function updateIndexCounter() { indexCounter.textContent = `(${discoveredBrainrots.size}/${totalBrainrotsCount})`; }
        
        function updateMoney() { 
            let totalMPS = 0;
            let baseRebirthMultiplier = 1 + rebirths * 0.02;
            baseSlots.forEach(b => {
                if (b) {
                    const mutationMultiplier = b.mutation?.multiplier || 1;
                    const traitMultiplier = b.trait?.multiplier || 1;
                    totalMPS += b.mps * mutationMultiplier * traitMultiplier;
                }
            });
            money += (totalMPS * baseRebirthMultiplier) / 60; 
            moneyDisplay.textContent = formatLargeNumber(Math.floor(money)); 
        }
        
        function updateTimerDisplay() { const nextSpawnTime = Math.min(timeUntilLegendary, timeUntilMythic, timeUntilBrainrotGod); const minutes = Math.floor(nextSpawnTime / 60).toString().padStart(2, '0'); const seconds = (nextSpawnTime % 60).toString().padStart(2, '0'); timerDisplay.textContent = `${minutes}:${seconds}`; }
        function handleRebirth() { if (!checkRebirthEligibility()) return; rebirths++; money = 100; updateDerivedState(); initBase(); beltItems.forEach(item => item.element.remove()); beltItems = []; renderBase(); updateAllUI(); closeRebirthModal(); }
        function checkRebirthEligibility() { const requirement = rebirthRequirements[rebirths]; if (!requirement) return false; const hasMoney = money >= requirement.cost; const baseUnitNames = baseSlots.filter(s => s).map(s => s.name); const hasUnits = requirement.units.every(unitName => baseUnitNames.includes(unitName)); return hasMoney && hasUnits; }
        function renderRebirthModal() { const requirement = rebirthRequirements[rebirths]; if (!requirement) { rebirthInfo.innerHTML = `<p class="text-xl font-bold text-center text-green-400">You have reached the maximum rebirth!</p>`; confirmRebirthButton.disabled = true; confirmRebirthButton.textContent = "Max Rebirth"; return; } const hasMoney = money >= requirement.cost; const baseUnitNames = baseSlots.filter(s => s).map(s => s.name); const unitsMet = requirement.units.map(u => baseUnitNames.includes(u)); const hasAllUnits = unitsMet.every(met => met); let reqHTML = `<h3 class="text-lg font-bold mb-2">Rebirth ${rebirths + 1} Requirements:</h3>`; reqHTML += `<p class="${hasMoney ? 'requirement-met' : 'requirement-not-met'}">ğŸ’° Money: $${formatLargeNumber(requirement.cost)}</p>`; reqHTML += `<h4 class="font-semibold mt-2">Required Brainrots:</h4><ul class="list-disc list-inside">`; requirement.units.forEach((unitName, index) => { reqHTML += `<li class="${unitsMet[index] ? 'requirement-met' : 'requirement-not-met'}">${unitName}</li>`; }); reqHTML += `</ul>`; rebirthInfo.innerHTML = reqHTML; confirmRebirthButton.disabled = !(hasMoney && hasAllUnits); confirmRebirthButton.textContent = `Confirm Rebirth (${rebirths + 1})`; }
        function togglePause() { isPaused = !isPaused; pauseButton.textContent = isPaused ? "Resume" : "Pause"; conveyorBelt.classList.toggle('paused', isPaused); }
        function toggleSellMode() { isSellMode = !isSellMode; sellButton.classList.toggle('active', isSellMode); baseContainer.querySelectorAll('.base-slot').forEach(slot => { const index = parseInt(slot.dataset.index, 10); if (baseSlots[index]) slot.classList.toggle('sell-mode', isSellMode); else slot.classList.remove('sell-mode'); }); }
        function openIndexModal() { renderIndex(); indexModal.classList.remove('hidden'); }
        function closeIndexModal() { indexModal.classList.add('hidden'); }
        function openRebirthModal() { renderRebirthModal(); rebirthModal.classList.remove('hidden'); }
        function closeRebirthModal() { rebirthModal.classList.add('hidden'); }
        function openRitualModal() { renderRitualModal(); ritualModal.classList.remove('hidden'); }
        function closeRitualModal() { ritualModal.classList.add('hidden'); }
        function openCraftMachineModal() { renderCraftModal(); craftMachineModal.classList.remove('hidden'); }
        function closeCraftMachineModal() { craftMachineModal.classList.add('hidden'); }
        function openFuseModal(type) { renderFuseModal(type); fuseModal.classList.remove('hidden'); }
        function closeFuseModal() { fuseModal.classList.add('hidden'); }
        function openDealerModal() { renderDealerModal(); dealerModal.classList.remove('hidden'); }
        function closeDealerModal() { dealerModal.classList.add('hidden'); }

        function renderIndex() {
            indexGridContainer.innerHTML = '';
            const categorizedBrainrots = {};
            allBrainrotData.forEach(brainrot => { if (!categorizedBrainrots[brainrot.rarity]) { categorizedBrainrots[brainrot.rarity] = []; } if (!categorizedBrainrots[brainrot.rarity].some(b => b.name === brainrot.name)) { categorizedBrainrots[brainrot.rarity].push(brainrot); } });
            const displayOrder = ['Common', 'Rare', 'Epic', 'Legendary', 'Mythic', 'Brainrot God', 'Secret', 'OG'];
            for (const rarityName of displayOrder) {
                if (!categorizedBrainrots[rarityName] || categorizedBrainrots[rarityName].length === 0) continue;
                const rarityData = rarities[rarityName];
                let sectionHTML = `<div class="col-span-full mt-4 first:mt-0"><h3 class="text-xl font-bold" style="color:${rarityData.color}; text-shadow: 0 0 5px ${rarityData.glow};">${rarityName}</h3><hr class="border-gray-600 my-1"></div><div class="col-span-full index-grid">`;
                categorizedBrainrots[rarityName].sort((a, b) => a.cost - b.cost);
                categorizedBrainrots[rarityName].forEach(brainrot => { const isDiscovered = discoveredBrainrots.has(brainrot.name); sectionHTML += `<div class="index-item ${isDiscovered ? '' : 'undiscovered'}"><div class="index-item-icon">${isDiscovered ? brainrot.icon : '?'}</div><div class="index-item-name">${isDiscovered ? brainrot.name : '???'}</div></div>`; });
                sectionHTML += '</div>';
                indexGridContainer.innerHTML += sectionHTML;
            }
        }
        
        function renderRitualModal() {
            ritualList.innerHTML = '';
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.name] = (acc[b.name] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);
            for (const ritualKey in ritualRecipes) {
                const resultData = findBrainrotData(ritualKey);
                const recipe = ritualRecipes[ritualKey];
                let canCraft = hasEmptySlot;
                let ingredientsHTML = '';
                for (const ingredientName in recipe.ingredients) {
                    const required = recipe.ingredients[ingredientName];
                    const owned = baseCounts[ingredientName] || 0;
                    const hasEnough = owned >= required;
                    if (!hasEnough) canCraft = false;
                    ingredientsHTML += `<li class="${hasEnough ? 'requirement-met' : 'requirement-not-met'}">${ingredientName} (${owned}/${required})</li>`;
                }
                const ritualEl = document.createElement('div');
                ritualEl.className = 'bg-gray-700 p-3 rounded-lg';
                ritualEl.innerHTML = `<div class="flex items-center justify-between"><div><h4 class="font-bold text-lg">${resultData.name}</h4><ul class="text-sm list-disc list-inside">${ingredientsHTML}</ul></div><button class="btn btn-red perform-ritual-btn" data-ritual-key="${ritualKey}" ${canCraft ? '' : 'disabled'}>Perform</button></div>`;
                ritualList.appendChild(ritualEl);
            }
        }

        function performRitual(ritualKey) {
            const recipe = ritualRecipes[ritualKey];
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.name] = (acc[b.name] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);
            let canCraft = hasEmptySlot;
            for (const ingredientName in recipe.ingredients) { if ((baseCounts[ingredientName] || 0) < recipe.ingredients[ingredientName]) { canCraft = false; break; } }
            if (!canCraft) { showNotification("Cannot perform ritual: Requirements not met or base is full.", "red"); return; }
            for (const ingredientName in recipe.ingredients) { let toRemove = recipe.ingredients[ingredientName]; for (let i = 0; i < baseSlots.length && toRemove > 0; i++) { if (baseSlots[i] && baseSlots[i].name === ingredientName) { baseSlots[i] = null; toRemove--; } } }
            const emptySlotIndex = baseSlots.findIndex(s => s === null);
            const resultData = findBrainrotData(ritualKey);
            baseSlots[emptySlotIndex] = { ...resultData, mutation: getRandomMutation(), trait: null };
            discoveredBrainrots.add(resultData.name);
            showNotification(`Ritual complete! You crafted a ${resultData.name}!`, rarities[resultData.rarity].color);
            renderBase(); updateAllUI(); renderRitualModal();
        }

        function renderCraftModal() {
            craftMachineList.innerHTML = '';
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.name] = (acc[b.name] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);
            for (const craftKey in craftRecipes) {
                const resultData = findBrainrotData(craftKey);
                const recipe = craftRecipes[craftKey];
                let canCraft = hasEmptySlot;
                let ingredientsHTML = '';
                for (const ingredientName in recipe.ingredients) {
                    const required = recipe.ingredients[ingredientName];
                    const owned = baseCounts[ingredientName] || 0;
                    const hasEnough = owned >= required;
                    if (!hasEnough) canCraft = false;
                    ingredientsHTML += `<li class="${hasEnough ? 'requirement-met' : 'requirement-not-met'}">${ingredientName} (${owned}/${required})</li>`;
                }
                const craftEl = document.createElement('div');
                craftEl.className = 'bg-gray-700 p-3 rounded-lg';
                craftEl.innerHTML = `<div class="flex items-center justify-between"><div><h4 class="font-bold text-lg">${resultData.name}</h4><ul class="text-sm list-disc list-inside">${ingredientsHTML}</ul></div><button class="btn btn-orange perform-craft-btn" data-craft-key="${craftKey}" ${canCraft ? '' : 'disabled'}>Craft</button></div>`;
                craftMachineList.appendChild(craftEl);
            }
        }

        function performCraft(craftKey) {
            const recipe = craftRecipes[craftKey];
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.name] = (acc[b.name] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);
            let canCraft = hasEmptySlot;
            for (const ingredientName in recipe.ingredients) { if ((baseCounts[ingredientName] || 0) < recipe.ingredients[ingredientName]) { canCraft = false; break; } }
            if (!canCraft) { showNotification("Cannot craft: Requirements not met or base is full.", "red"); return; }
            for (const ingredientName in recipe.ingredients) { let toRemove = recipe.ingredients[ingredientName]; for (let i = 0; i < baseSlots.length && toRemove > 0; i++) { if (baseSlots[i] && baseSlots[i].name === ingredientName) { baseSlots[i] = null; toRemove--; } } }
            const emptySlotIndex = baseSlots.findIndex(s => s === null);
            const resultData = findBrainrotData(craftKey);
            baseSlots[emptySlotIndex] = { ...resultData, mutation: getRandomMutation(), trait: null };
            discoveredBrainrots.add(resultData.name);
            showNotification(`Craft complete! You made a ${resultData.name}!`, rarities[resultData.rarity].color);
            renderBase(); updateAllUI(); renderCraftModal();
        }

        function renderFuseModal(type) {
            fuseModal.dataset.type = type;
            fuseModalTitle.textContent = `${type} Fuse`;
            fuseModalList.innerHTML = '';
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.rarity] = (acc[b.rarity] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);

            fuseRecipes[type].forEach(recipe => {
                const owned = baseCounts[recipe.inputRarity] || 0;
                const hasEnough = owned >= recipe.count;
                const canFuse = hasEmptySlot && hasEnough;
                const resultRarity = findBrainrotData(recipe.output[0]).rarity;

                const fuseEl = document.createElement('div');
                fuseEl.className = 'bg-gray-700 p-3 rounded-lg';
                fuseEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-lg">Fuse ${recipe.count} <span style="color: ${rarities[recipe.inputRarity].color}">${recipe.inputRarity}</span></h4>
                            <p class="text-sm">Result: 1x Random <span style="color: ${rarities[resultRarity].color}">${resultRarity}</span></p>
                            <p class="text-sm ${hasEnough ? 'requirement-met' : 'requirement-not-met'}">Owned: ${owned}/${recipe.count}</p>
                        </div>
                        <button class="btn btn-cyan perform-fuse-btn" data-input-rarity="${recipe.inputRarity}" ${canFuse ? '' : 'disabled'}>Fuse</button>
                    </div>`;
                fuseModalList.appendChild(fuseEl);
            });
        }

        function performFuse(inputRarity, type) {
            const recipe = fuseRecipes[type].find(r => r.inputRarity === inputRarity);
            if (!recipe) return;
            const baseCounts = baseSlots.filter(s => s).reduce((acc, b) => { acc[b.rarity] = (acc[b.rarity] || 0) + 1; return acc; }, {});
            const hasEmptySlot = baseSlots.some(s => s === null);
            const hasEnough = (baseCounts[inputRarity] || 0) >= recipe.count;

            if (!hasEmptySlot || !hasEnough) {
                showNotification("Cannot fuse: Requirements not met or base is full.", "red");
                return;
            }
            
            let toRemove = recipe.count;
            for (let i = 0; i < baseSlots.length && toRemove > 0; i++) {
                if (baseSlots[i] && baseSlots[i].rarity === inputRarity) {
                    baseSlots[i] = null;
                    toRemove--;
                }
            }

            const emptySlotIndex = baseSlots.findIndex(s => s === null);
            const resultName = recipe.output[Math.floor(Math.random() * recipe.output.length)];
            const resultData = findBrainrotData(resultName);
            baseSlots[emptySlotIndex] = { ...resultData, mutation: getRandomMutation(), trait: null };
            discoveredBrainrots.add(resultData.name);
            showNotification(`Fuse complete! You got a ${resultData.name}!`, rarities[resultData.rarity].color);
            renderBase(); updateAllUI(); renderFuseModal(type);
        }

        function renderDealerModal() {
            dealerList.innerHTML = '';
            const hasEmptySlot = baseSlots.some(s => s === null);

            for (const name in dealerExclusives) {
                const data = dealerExclusives[name];
                const stock = currentDealerStock[name] || 0;
                const canAfford = money >= data.cost;
                const canBuy = hasEmptySlot && canAfford && stock > 0;

                const dealerEl = document.createElement('div');
                dealerEl.className = 'bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                dealerEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">${data.icon}</div>
                        <div>
                            <h4 class="font-bold">${name} <span style="color: ${rarities[data.rarity].color}">(${data.rarity})</span></h4>
                            <div class="text-sm">Cost: <span class="text-green-400">$${formatLargeNumber(data.cost)}</span> | MPS: <span class="text-yellow-400">${formatLargeNumber(data.mps)}</span></div>
                            <div class="text-sm ${stock > 0 ? 'text-white' : 'text-red-500'}">Stock: ${stock}</div>
                        </div>
                    </div>
                    <button class="btn btn-green buy-dealer-btn" data-item-name="${name}" ${canBuy ? '' : 'disabled'}>Buy</button>
                `;
                dealerList.appendChild(dealerEl);
            }
        }

        function buyFromDealer(itemName) {
            const data = dealerExclusives[itemName];
            const stock = currentDealerStock[itemName];
            const emptySlotIndex = baseSlots.findIndex(s => s === null);

            if (money < data.cost) { showNotification("Not enough money!", "red"); return; }
            if (stock <= 0) { showNotification("Out of stock!", "red"); return; }
            if (emptySlotIndex === -1) { showNotification("Base is full!", "red"); return; }

            money -= data.cost;
            currentDealerStock[itemName]--;
            baseSlots[emptySlotIndex] = { name: itemName, ...data, mutation: getRandomMutation(), trait: null };
            discoveredBrainrots.add(itemName);
            
            renderBase();
            updateAllUI();
            renderDealerModal();
            showNotification(`Bought ${itemName} from Dealer!`, "green");
        }
        
        async function saveGame() {
            if (!db || !userId) {
                showNotification("Cannot save: Not connected to cloud.", "red");
                return;
            }
            const saveData = { 
                money: money, 
                baseSlots: baseSlots,
                discovered: Array.from(discoveredBrainrots),
                rebirths: rebirths, 
                luck: luck, 
                activeEvents: activeEvents,
                dealerStock: currentDealerStock
            };
            
            try {
                await setDoc(doc(db, userSaveDocPath), saveData);
                showNotification("Game Saved to Cloud!", "green");
            } catch (error) {
                console.error("Failed to save game:", error);
                showNotification("Save Failed!", "red");
            }
        }
        
        async function loadGame() { // This is the FIREBASE loader
            if (!db || !userId) return; // Don't try to load if no DB
            try {
                const docSnap = await getDoc(doc(db, userSaveDocPath));
                if (docSnap.exists()) {
                    const parsedData = docSnap.data();
                    loadGameData(parsedData, "Cloud"); // Pass source
                } else {
                    console.log("No saved game found in cloud.");
                    // This is a new player, just continue with defaults
                }
            } catch (error) {
                console.error("Failed to load save data:", error);
                showNotification("Load Failed: Could not reach cloud save.", "red");
            }
        }

        function loadGameFromFile() {
            // This function now just triggers the hidden file input
            loadFileInput.click();
        }

        function loadGameData(parsedData, source = "File") { // Consolidated load function
            try {
                money = parsedData.money || 100;
                rebirths = parsedData.rebirths || 0;
                luck = parsedData.luck || 0;
                activeEvents = parsedData.activeEvents || {};
                currentDealerStock = parsedData.dealerStock || {};
                
                updateDerivedState();
                initBase();
                
                const loadedBase = parsedData.baseSlots || [];
                for(let i = 0; i < maxBaseSlots; i++) {
                    baseSlots[i] = loadedBase[i] || null;
                }

                discoveredBrainrots = new Set(parsedData.discovered || []);
                
                renderBase();
                updateAllUI();
                updateActiveEventsUI();
                showNotification(`Game Loaded from ${source}!`, "green");
            } catch (error) {
                console.error("Failed to load save data:", error);
                showNotification(`Load Failed: Invalid ${source} data.`, "red");
            }
        }

        function openJayceModal() { jayceModal.classList.remove('hidden'); }
        function closeJayceModal() { jayceModal.classList.add('hidden'); }
        function jayceLogin() { 
            if (jaycePasswordInput.value === "BayHarbourButcher") { 
                isAdmin = true;
                jaycePasswordScreen.classList.add('hidden'); 
                jayceCommandScreen.classList.remove('hidden'); 
                jayceError.textContent = ''; 
                showNotification("Jayce Mode Activated", "cyan");
            } else { 
                isAdmin = false;
                jayceError.textContent = 'Incorrect Password.'; 
            } 
            jaycePasswordInput.value = ''; 
        }

        function jayceLogout() {
            isAdmin = false;
            jaycePasswordScreen.classList.remove('hidden');
            jayceCommandScreen.classList.add('hidden');
            closeJayceModal();
            showNotification("Jayce Mode Deactivated", "gray");
        }
        
        function populateAdminDropdowns() {
            const spawnSelect = document.getElementById('jayce-spawn-select');
            const giveSelect = document.getElementById('jayce-give-select');
            const spawnMutation = document.getElementById('jayce-spawn-mutation');
            const giveMutation = document.getElementById('jayce-give-mutation');
            const spawnTrait = document.getElementById('jayce-spawn-trait');
            const giveTrait = document.getElementById('jayce-give-trait');
            const eventSelect = document.getElementById('jayce-event-select');
            const restockSelect = document.getElementById('jayce-restock-select');
            
            spawnSelect.innerHTML = ''; giveSelect.innerHTML = '';
            spawnMutation.innerHTML = ''; giveMutation.innerHTML = '';
            spawnTrait.innerHTML = ''; giveTrait.innerHTML = '';
            eventSelect.innerHTML = '';
            restockSelect.innerHTML = '<option value="All">All Items</option>';
            
            const raritySortOrder = ['Common', 'Rare', 'Epic', 'Legendary', 'Mythic', 'Brainrot God', 'Secret', 'OG'];
            allBrainrotData.sort((a, b) => {
                const rarityA = raritySortOrder.indexOf(a.rarity);
                const rarityB = raritySortOrder.indexOf(b.rarity);
                if (rarityA !== rarityB) {
                    return rarityA - rarityB;
                }
                return a.name.localeCompare(b.name);
            });

            let currentRarity = '';
            allBrainrotData.forEach(b => {
                if (b.rarity !== currentRarity) {
                    currentRarity = b.rarity;
                    if(raritySortOrder.includes(currentRarity)) {
                        const optgroupGive = document.createElement('optgroup');
                        optgroupGive.label = currentRarity;
                        giveSelect.appendChild(optgroupGive);
                        const optgroupSpawn = document.createElement('optgroup');
                        optgroupSpawn.label = currentRarity;
                        spawnSelect.appendChild(optgroupSpawn);
                    }
                }
                const option = document.createElement('option');
                option.value = b.name;
                option.textContent = b.name;
                if(giveSelect.querySelector(`optgroup[label="${currentRarity}"]`)) {
                    giveSelect.querySelector(`optgroup[label="${currentRarity}"]`).appendChild(option.cloneNode(true));
                    spawnSelect.querySelector(`optgroup[label="${currentRarity}"]`).appendChild(option.cloneNode(true));
                }
            });

            const luckyBlockOptGroup = document.createElement('optgroup');
            luckyBlockOptGroup.label = "Lucky Blocks";
            Object.keys(luckyBlockManifest).forEach(name => {
                const option = document.createElement('option');
                option.value = `lucky_block_${name}`;
                option.textContent = name;
                luckyBlockOptGroup.appendChild(option);
            });
            spawnSelect.appendChild(luckyBlockOptGroup);

            Object.values(mutations).forEach(m => {
                const option = document.createElement('option');
                option.value = m.name;
                option.textContent = m.name;
                spawnMutation.appendChild(option.cloneNode(true));
                giveMutation.appendChild(option.cloneNode(true));
            });

            spawnTrait.innerHTML = '<option value="None">None</option><option value="All">All (Random)</option>';
            giveTrait.innerHTML = '<option value="None">None</option><option value="All">All (Random)</option>';
            Object.values(weatherEvents).forEach(e => {
                const option = document.createElement('option');
                option.value = e.name;
                option.textContent = e.name;
                spawnTrait.appendChild(option.cloneNode(true));
                giveTrait.appendChild(option.cloneNode(true));
                eventSelect.appendChild(option.cloneNode(true));
            });

            for(const name in dealerExclusives) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                restockSelect.appendChild(option);
            }
        }
        
        function showNotification(message, color = 'white') {
            notification.textContent = message;
            notification.style.borderColor = color;
            notification.style.top = '20px';
            notification.style.visibility = 'visible';
            notification.style.opacity = '1';
            setTimeout(() => {
                notification.style.top = '-50px';
                notification.style.opacity = '0';
                notification.style.visibility = 'hidden';
            }, 3000);
        }

        function getRandomRarity() { 
            let adjustedWeights = JSON.parse(JSON.stringify(rarities)); 
            let commonWeight = adjustedWeights['Common'].weight; 
            let eventLuck = Object.values(activeEvents).reduce((s, e) => s + (e.luck || 0), 0);
            let reduction = Math.min(commonWeight * 0.85, (rebirths * 5) + luck + eventLuck); 
            adjustedWeights['Common'].weight -= reduction; 
            let increasePerOther = reduction / (Object.keys(adjustedWeights).length - 1); 
            for(const r in adjustedWeights) { if (r !== 'Common') { adjustedWeights[r].weight += increasePerOther; } } 
            const currentTotalWeight = Object.values(adjustedWeights).reduce((sum, r) => sum + r.weight, 0); 
            let random = Math.random() * currentTotalWeight; 
            for (const rarityName in adjustedWeights) { const rarity = adjustedWeights[rarityName]; if (random < rarity.weight) return rarityName; random -= rarity.weight; } 
        }
        
        function getRandomMutation() {
            let eventRainbow = Object.values(activeEvents).some(e => e.rainbow);
            if(eventRainbow && Math.random() < 0.25) return mutations['Rainbow']; // 25% chance during event
            
            let rand = Math.random();
            if (rand < mutations['Rainbow'].chance) return mutations['Rainbow'];
            if (rand < mutations['Diamond'].chance) return mutations['Diamond'];
            if (rand < mutations['Gold'].chance) return mutations['Gold'];
            return mutations['None'];
        }

        function startWeatherEvent(eventName) {
            if (!weatherEvents[eventName]) return;
            const event = { ...weatherEvents[eventName] };
            activeEvents[eventName] = event;
            showNotification(`${event.name} event has started!`, event.color || '#fff');
            
            if (event.spawn) spawnBrainrotByName(event.spawn);
            
            // *** CHANGE: Do NOT apply traits to existing base items ***
            updateAllUI();
            updateActiveEventsUI();
        }

        function updateActiveEvents() {
            let needsUpdate = false;
            for(const eventName in activeEvents) {
                activeEvents[eventName].duration--;
                if(activeEvents[eventName].duration <= 0) {
                    showNotification(`${eventName} event has ended.`, 'gray');
                    delete activeEvents[eventName];
                    needsUpdate = true;
                }
            }
            if(needsUpdate) {
                baseSlots.forEach(slot => {
                    if (slot && slot.trait && !activeEvents[slot.trait.name]) {
                        slot.trait = null;
                    }
                });
                renderBase();
                updateAllUI();
            }
            updateActiveEventsUI();
        }

        function updateActiveEventsUI() {
            activeEventsList.innerHTML = '';
            for (const eventName in activeEvents) {
                const event = activeEvents[eventName];
                activeEventsList.innerHTML += `<span title="${event.name} (${event.duration}s left)" style="color: ${event.color || '#fff'}">${event.icon}</span>`;
            }
        }

        function checkTacoTuesday() {
            const today = new Date();
            if (today.getDay() === 2) { // 0=Sun, 1=Mon, 2=Tue
                startTacoEvent();
            }
        }

        function startTacoEvent() {
            openTacoFuseButton.classList.remove('hidden');
            if (tacoEventInterval) clearInterval(tacoEventInterval);
            tacoEventInterval = setInterval(() => {
                if (!isPaused) {
                    spawnLuckyBlockOnBelt('Taco Lucky Block');
                }
            }, 300000); // 5 minutes
            showNotification('Taco Tuesday is active! Taco Blocks will spawn!', '#f59e0b');
        }

        function formatLargeNumber(num) { if (num >= 1e15) return (num / 1e15).toFixed(2) + 'Qa'; if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T'; if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B'; if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M'; if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K'; return Math.floor(num).toLocaleString(); }
        
        // --- Event Listeners and Init ---
        document.getElementById('jayce-send-chat').addEventListener('click', () => {
            const message = document.getElementById('jayce-chat-input').value;
            if(message) {
                sendGlobalEvent('chat', { message: message });
                document.getElementById('jayce-chat-input').value = '';
            }
        });

        document.getElementById('jayce-spawn-button').addEventListener('click', () => { 
            const value = document.getElementById('jayce-spawn-select').value; 
            const mutation = mutations[document.getElementById('jayce-spawn-mutation').value];
            let traitName = document.getElementById('jayce-spawn-trait').value;
            let trait = null;
            if (traitName === 'All') {
                const allTraits = Object.values(weatherEvents);
                trait = allTraits[Math.floor(Math.random() * allTraits.length)];
            } else if (traitName !== 'None') {
                trait = weatherEvents[traitName];
            }
            
            if (value.startsWith('lucky_block_')) { 
                const blockType = value.replace('lucky_block_', ''); 
                sendGlobalEvent('spawn_lucky_block', { name: blockType });
            } else { 
                sendGlobalEvent('spawn', { name: value, mutation, trait });
            } 
        });
        document.getElementById('jayce-give-money').addEventListener('click', () => { const amount = parseFloat(document.getElementById('jayce-money-input').value); if (!isNaN(amount)) { money += amount; updateAllUI(); } });
        document.getElementById('jayce-give-button').addEventListener('click', () => { 
            const brainrotName = document.getElementById('jayce-give-select').value; 
            const emptySlotIndex = baseSlots.findIndex(s => s === null); 
            if (emptySlotIndex === -1) { showNotification("Base is full!", "red"); return; } 
            const data = findBrainrotData(brainrotName); 
            if (data) { 
                const mutation = mutations[document.getElementById('jayce-give-mutation').value];
                let traitName = document.getElementById('jayce-give-trait').value;
                let trait = null;
                if (traitName === 'All') {
                    const allTraits = Object.values(weatherEvents);
                    trait = allTraits[Math.floor(Math.random() * allTraits.length)];
                } else if (traitName !== 'None') {
                    trait = weatherEvents[traitName];
                }
                baseSlots[emptySlotIndex] = { ...data, mutation, trait }; 
                discoveredBrainrots.add(data.name); 
                renderBase(); 
                updateAllUI(); 
            } 
        });
        document.getElementById('jayce-give-rebirth').addEventListener('click', () => { const level = parseInt(document.getElementById('jayce-rebirth-input').value, 10); if (!isNaN(level) && level >= 0) { rebirths = level; updateDerivedState(); initBase(); renderBase(); updateAllUI(); } });
        document.getElementById('jayce-give-luck').addEventListener('click', () => { const amount = parseFloat(document.getElementById('jayce-luck-input').value); if (!isNaN(amount)) { luck += amount; showNotification(`Luck set to ${luck}`, 'cyan');} });
        document.getElementById('jayce-unlock-index').addEventListener('click', () => {
            allBrainrotData.forEach(b => discoveredBrainrots.add(b.name));
            updateIndexCounter(); 
            showNotification('Index Unlocked!', 'green');
        });
        document.getElementById('jayce-event-taco').addEventListener('click', () => sendGlobalEvent('taco_event', {}));
        document.getElementById('jayce-event-run-all').addEventListener('click', () => sendGlobalEvent('all_events', {}));
        document.getElementById('jayce-event-stop-all').addEventListener('click', () => sendGlobalEvent('stop_all_events', {}));
        document.getElementById('jayce-event-run-global').addEventListener('click', () => {
            const eventName = document.getElementById('jayce-event-select').value;
            sendGlobalEvent('event', { name: eventName });
        });
        document.getElementById('jayce-restock-button').addEventListener('click', () => {
            const itemName = document.getElementById('jayce-restock-select').value;
            sendGlobalEvent('restock_dealer', { item: itemName });
        });
        jayceLogoutButton.addEventListener('click', jayceLogout);


        window.onload = initializeFirebase; // Start Firebase on load
        pauseButton.addEventListener('click', togglePause);
        saveButton.addEventListener('click', saveGame); // Firebase Save
        
        loadButton.addEventListener('click', () => { // File load
            showNotification("Loading from file...", "cyan");
            loadFileInput.click();
        });
        
        loadFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const parsedData = JSON.parse(text);
                    loadGameData(parsedData, "File"); // Pass source
                } catch (error) {
                    console.error("Error reading save file:", error);
                    showNotification("Load Failed: Invalid file format.", "red");
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        });

        sellButton.addEventListener('click', toggleSellMode);
        indexButton.addEventListener('click', openIndexModal);
        closeIndexButton.addEventListener('click', closeIndexModal);
        indexModal.addEventListener('click', (e) => { if(e.target === indexModal) closeIndexModal() });
        openRebirthButton.addEventListener('click', openRebirthModal);
        closeRebirthButton.addEventListener('click', closeRebirthModal);
        confirmRebirthButton.addEventListener('click', handleRebirth);
        rebirthModal.addEventListener('click', (e) => { if(e.target === rebirthModal) closeRebirthModal() });
        window.addEventListener('keydown', (e) => { if (e.key === '-') { openJayceModal(); } });
        closeJayceButton.addEventListener('click', closeJayceModal);
        jayceLoginButton.addEventListener('click', jayceLogin);
        jaycePasswordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') jayceLogin() });
        baseContainer.addEventListener('mouseover', (e) => { 
            const slot = e.target.closest('.base-slot'); 
            if (!slot) return; 
            const index = parseInt(slot.dataset.index, 10); 
            const brainrot = baseSlots[index]; 
            if (brainrot) { 
                const sellPrice = Math.floor(brainrot.cost * SELL_MULTIPLIER); 
                let tooltipHTML = `<div class="font-bold">${brainrot.name}</div><div>Sell: <span class="text-green-400">$${formatLargeNumber(sellPrice)}</span></div><div>Base MPS: <span class="text-yellow-400">${formatLargeNumber(brainrot.mps)}</span></div>`;
                if (brainrot.mutation && brainrot.mutation.name !== 'None') { tooltipHTML += `<div>${brainrot.mutation.name}: <span style="color: ${brainrot.mutation.color}">x${brainrot.mutation.multiplier} MPS</span></div>`; }
                if (brainrot.trait) { tooltipHTML += `<div>${brainrot.trait.name}: <span style="color: ${brainrot.trait.color}">x${brainrot.trait.multiplier} MPS</span></div>`; }
                globalTooltip.innerHTML = tooltipHTML;
                const rect = slot.getBoundingClientRect(); 
                globalTooltip.classList.remove('hidden'); 
                const tooltipRect = globalTooltip.getBoundingClientRect(); 
                let top = rect.top - tooltipRect.height - 8; 
                let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2); 
                if (top < 0) { top = rect.bottom + 8; } 
                if (left < 0) { left = 5; } 
                if (left + tooltipRect.width > window.innerWidth) { left = window.innerWidth - tooltipRect.width - 5; } 
                globalTooltip.style.top = `${top}px`; 
                globalTooltip.style.left = `${left}px`; 
            } 
        });
        baseContainer.addEventListener('mouseout', () => { globalTooltip.classList.add('hidden'); });

        openRitualButton.addEventListener('click', openRitualModal);
        closeRitualButton.addEventListener('click', closeRitualModal);
        ritualModal.addEventListener('click', (e) => { if (e.target === ritualModal) closeRitualModal(); });
        ritualList.addEventListener('click', (e) => { if (e.target.classList.contains('perform-ritual-btn')) { performRitual(e.target.dataset.ritualKey); } });

        openCraftMachineButton.addEventListener('click', openCraftMachineModal);
        closeCraftMachineButton.addEventListener('click', closeCraftMachineModal);
        craftMachineModal.addEventListener('click', (e) => { if (e.target === craftMachineModal) closeCraftMachineModal(); });
        craftMachineList.addEventListener('click', (e) => { if (e.target.classList.contains('perform-craft-btn')) { performCraft(e.target.dataset.craftKey); } });

        openNormalFuseButton.addEventListener('click', () => openFuseModal('Normal'));
        openWitchFuseButton.addEventListener('click', () => openFuseModal('Witch'));
        openTacoFuseButton.addEventListener('click', () => openFuseModal('Taco'));
        closeFuseModalButton.addEventListener('click', closeFuseModal);
        fuseModal.addEventListener('click', (e) => { if (e.target === fuseModal) closeFuseModal(); });
        fuseModalList.addEventListener('click', (e) => {
            if (e.target.classList.contains('perform-fuse-btn')) {
                performFuse(e.target.dataset.inputRarity, fuseModal.dataset.type);
            }
        });

        openDealerButton.addEventListener('click', openDealerModal);
        closeDealerButton.addEventListener('click', closeDealerModal);
        dealerModal.addEventListener('click', (e) => { if (e.target === dealerModal) closeDealerModal(); });
        dealerList.addEventListener('click', (e) => {
            if (e.target.classList.contains('buy-dealer-btn')) {
                buyFromDealer(e.target.dataset.itemName);
            }
        });

    </script>
</body>
</html>
